---
title: "School Personnel and School Climate"
author: "TEAM QRME"
date: "11/10/2021"
output: 
    html_document:
        toc: true
        toc_float: true
        toc_depth: 3
        highlight: pygments
        code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      error = FALSE,
                      fig.width = 9, 
                      fig.height = 9)

#<<<<<<< Updated upstream

# Add your packages that you need here. This will load the libraries
#removed purr - part of tidyverse
#let's only include libraries we are using so that others don't have to install the irrelevant ones 
#if (!require("pacman")) install.packages("pacman") 
#pacman::p_load(tidyverse, rio, here, ggridges, readr, ggthemes, sandwich, pracma, lme4,equatiomatic, performance, jtools, sundry,naniar,stargazer,vtable, reshape2, skimr, rddtools,tidylog,janitor) 
pacman::p_load(tidyverse, rio, here, ggridges, ggthemes, skimr, tidylog, janitor, reshape2, psych,jtools, lme4, sjPlot, sjmisc) 
#>>>>>>> Stashed changes

if (!require("pacman")) install.packages("pacman") 
pacman::p_load(tidyverse, rio, here, ggridges, ggthemes, skimr, tidylog, janitor, reshape2, psych,jtools, lme4, sjPlot, performance,sjmisc, gtsummary) 

```

# Abstract

# Relationship Between School Staffing and Student Suspensions, Referrals, and Arrests

[Sentence that gives an overview of the study] This research project will be conducted using High school, Middle school, and Elementary school level data from the [**Civil Rights Data Collection (CRDC)**] (https://ocrdata.ed.gov/), 2017-2018 data set. The CRDC contains multiple data sets that cover a range of topics. From the overall data set, we are focusing on data reported in the following areas: 

1. School Support (count of enrolled novice teachers, sworn law enforcement officers (LEOs) and security guards)
2. Referrals & Arrests (count of referrals and arrests of students by subgroup, which includes gender, race, and disability status)
3. Suspensions and Expulsions (count of suspensions and expulsions of students by subgroup)
4. Enrollment (count of enrolled students by subgroup)
5. School characteristics (magnet, alternate, charter, special ed)
6. Data sets are organized by both state, school district (LEA), and school level

## Prior Literature

Previous research has shown that school staffing choices can have an impact on student outcomes. In particular, novice teachers and law enforcement officials located on school campuses may impact negatively the number of disciplinary actions taken with students of various subgroups. Often, poor classroom management by novice teachers leads to them sending more students to the school office for a form of disciplinary action (e.g., referrals, suspensions, and even arrests) (Taylor et al., 2018). Less research has been done on how law enforcement officials impact student disciplinary outcomes, but there have been some studies that suggest there are both benefits (i.e., deterring student to student assaults) and costs (i.e., more students reported for "non-serious violent crimes") (James & McCallion, 2013). 

[Errol - add info about mechanisms/connection between x and y variables]

## Research Questions  [update using presentaiton RQs]

**1. Relationship of Concentration of novice teachers and rate of exclusionary discipline (i.e., suspensions, expulsions) in K-12 school students** 

* Vary by student subgroups? (i.e. race, disability)
* Vary district?
* Vary by state?


**2. Relationship of security guard density and referrals + arrests in K-12 school students** 

* Should we see if there is any correlation between corporal punishment and security guard presence?
* Might vary by student characteristic (e.g., students with disabilities, gender, grade level, or race)
* Number of transfers out of schools with guards might be at an increased level


The rest of this document summarizes methods, results and ends with a discusion.

```{r}
na_strings <- c(-3, -5, -6, -8, -9, -11)
```

<!-- RA = referrals and arrests -->
```{r}
RA <- import(here("data", "Referrals and Arrests.csv")) %>%
as_tibble() %>%
 
set_na(na = c(-3, -5, -6, -8, -9, -11))

RA
```

```{r}
# export(RA, here("data", "RA.xlsx"))
```

```{r}
skim(RA)
```

<!-- Verify that COMBOKEY is the key for joining -->
```{r}
RA %>%
count(COMBOKEY)
```

<!-- Describe the RA data set -->
```{r}
RA %>%
  describeBy()
```

```{r}
str(RA)
```

```{r}
enroll <- import(here("data", "enroll.csv")) %>%
as_tibble() %>%
 
set_na(na = c(-3, -5, -6, -8, -9, -11))
```

<!-- Describe the enroll data set -->
```{r}
enroll %>%
  describeBy()
```

```{r}
str(enroll)
```

```{r}
RA2 <- RA %>%
  clean_names()

RA2
```

```{r}
enroll2 <- enroll %>%
  clean_names()

enroll2
```

```{r}
ra_full <- merge(x=RA2, y=enroll2, by="combokey") %>%
  select(! ends_with(".y"))


ra_full
```

```{r}
# export(ra_full, here("data", "ra_full.csv"))
```

```{r}
# export(ra_full, here("data", "ra_full2.xlsx"))
```

```{r}
sch_su <- import(here("data", "sch_su.csv")) %>%
as_tibble() %>%
 
set_na(na = c(-3, -5, -6, -8, -9, -11)) %>%
  clean_names()

sch_su
```

<!-- Complete data set -->
<!-- For rename function new name = old name -->
```{r}
ra_final <- merge(x=ra_full, y=sch_su, by="combokey") %>%
  select(! ends_with(".y")) %>%
  subset(select = -c(schid, leaid, lea_name)) %>%
    rename(lea_state=lea_state.x, lea_state_name = lea_state_name.x, leaid= leaid.x, lea_name=lea_name.x, schid=schid.x, sch_name=sch_name.x, jj=jj.x)

ra_final
```

```{r}
# export(ra_final, here("data", "ra_final.csv"))
```

```{r}
# export(ra_final, here("data", "ra_final4.xlsx"))
```

<!-- Dropping variables to show just the state and totals -->
<!-- ra_lawst is referrals and arrests by state -->
```{r}
ra_lawst <- ra_final %>%
select(lea_state_name, starts_with("tot")) %>%
  set_na(na = c(-3, -5, -6, -8, -9, -11))

ra_lawst
```

<!-- Sum by state -->
```{r}
ra_sum <- ra_lawst %>%
  group_by(lea_state_name) %>%
  summarise_all(sum, na.rm = TRUE) %>%
  filter(lea_state_name != "NA")

ra_sum
```

```{r}
# export(ra_lawst, here("data", "ra_lawst2.xlsx"))
```

<!-- pivot_longer to rearrange the data with less columns & more rows -->
<!-- tot_st is total number of students -->
```{r}
ra_sum2 <- ra_sum %>%
  pivot_longer(cols = starts_with("tot_"),
    names_to = "student_type",
    names_prefix = "tot_disc",
    values_to = "tot_st",
    values_drop_na = TRUE)

ra_sum2
```

<!-- IDEA (Individuals with Disabilities Education Act) -->
<!-- LEP stands for limited English Proficient -->
<!-- arr = Arrests, ref = referrals, wdis = with disability, & wodis = with out disability, dis_act = disciplinary action -->
```{r}
ra_sum3 <- ra_sum2 %>%
  mutate_at("student_type", str_replace, "_idea", "") %>%
  separate(student_type, c("status", "dis_act", "gender"), "_")

ra_sum3
```

```{r}
new_labels <- c("ref" = "Referrals", "arr" = "Arrests")
```

<!-- How to get it to show a break in the gender indicating disability status or a percentage of each gender that is disabled? -->
<!-- fct_rev added to flip state names alphabetical -->
<!-- labeller used to spell out facet_wrap labels -->
```{r}
ra_sum3 %>%
  ggplot(aes(x = fct_rev(lea_state_name), y = tot_st)) +
  geom_col(aes(fill = gender)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip() +
  facet_wrap(~dis_act, labeller = labeller(dis_act = new_labels)) +
  theme(panel.grid.major.y = element_line(colour = "black"), panel.background = element_blank(), strip.background =element_rect(fill="gold1")) +
  labs(x = "State",
       y = "Total",
       title = "Number of Student Arrests and Referrals by State",
       subtitle = "Visulalized by Gender") +
  scale_fill_discrete (name = "Gender", labels = c("Female", "Male")) +
  theme(axis.text=element_text(size=14), legend.text=element_text(size = 14))
```

```{r}
ra_sum3 %>%
  ggplot(aes(x = fct_rev(lea_state_name), y = tot_st)) +
  geom_col(aes(fill = status)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip() +
  facet_wrap(~dis_act, labeller = labeller(dis_act = new_labels)) +
  theme(panel.grid.major.y = element_line(colour = "black"), panel.background = element_blank(), strip.background =element_rect(fill="darkolivegreen3")) +
  labs(x = "State",
       y = "Total",
       title = "Number of Student Arrests and Referrals by State",
       subtitle = "Visulalized by Disability Status") +
  scale_fill_manual (name = "Disability Status", values = c("darksalmon", "tomato4"), labels = c("Yes", "No"))+
  theme(axis.text=element_text(size=14), legend.text=element_text(size = 14))
```



<!-- ## Cleaning different files -->

<!-- Since we're using multiple files, we created a master file to have all the necessary variables in one data set, called data_joined. We exported this file to reduce the run-time of the code. Below is our data cleaning process, but `eval = FALSE` as we don't want to run this code each time. -->

<!-- ### Enrollment Data Set -->

<!-- Read file -->

```{r load enroll file, eval = FALSE}
enroll <- import(here("data", "Enrollment.csv")) %>%
    as_tibble() %>%
    clean_names()

```

<!-- Change negative to NA -->

```{r enroll remove neg, eval = FALSE}
#Function to remove negative numbers from data

remove_neg <- function (x) ifelse(x < 0, NA, x)

enroll <- enroll %>% 
    mutate(across(c(9:123), remove_neg)) %>% 
    select(-c(9:31))  #removing pre-K enrollment data
```

<!-- Now, I'm using PivotLonger and PivotWider to extract all information from columns. -->

```{r enroll tidy_1, eval = FALSE}
#Extracting information for columns starting with 'tot_'

enroll_total <- enroll %>% 
        select(c(1:8), matches('tot'))%>% 
        pivot_longer(
            cols = -c(1:8), 
            names_to = c("enroll_type", "gender"),
            names_sep = "_",
            names_prefix = "tot_",
            values_to = "students" 
        ) %>%
    group_by(combokey, enroll_type) %>% 
        summarize(
            total = sum(students, na.rm = TRUE)
        ) %>% 
    pivot_wider(
        names_from = 2,
        values_from = total,
        names_sep = "_",
        names_prefix = "tot_"
    ) %>% 
  as_tibble()

```


```{r enroll tidy_2, eval = FALSE}
#Extracting information for columns starting with 'sch_'

enroll_tidy <- enroll %>% 
        select(-matches('tot'))%>% 
        pivot_longer(
            cols = -c(1:8), 
            names_to = c("enroll_type", "classification","gender"),
            names_sep = "_",
            names_prefix = "sch_",
            values_to = "students" 
        ) %>%         
        group_by(combokey, enroll_type, classification) %>% 
        summarize(
            total = sum(students, na.rm = TRUE)
        ) %>% 
      pivot_wider(
        names_from = c(2:3),
        values_from = total,
        names_sep = "_",
        names_prefix = "sch_"
    ) %>% 
    as_tibble()

```

```{r enroll joining, eval = FALSE}
#Joining all files to have information for analysis

enroll_final <- enroll_tidy %>% 
    right_join(.,enroll[,1:8],by = 'combokey') %>% 
    right_join(., enroll_total,by = 'combokey') %>%
    select(c(lea_state:jj), combokey, 'tot_enr',contains("_enr_"), everything()) %>% 
    as_tibble()
```


```{r enrol pct, eval = FALSE}
# Expressing enrollment across categories as percentage of total enrollment

enroll_final <- enroll_final %>%
  mutate(across(-c(1:9), ~ . / !! enroll_final$tot_enr * 100)) 
```

<!-- Note: For 11 schools, total enrollment is 0. Therefore, the percentages come as NA for them. Probably because these schools only have preK enrollment.  -->

```{r enroll errors, eval = FALSE}
enroll_100 <- enroll_final %>% 
  select(c(1:19)) %>% 
  filter_at(vars(c(10:19)),any_vars(.>100))
```

<!-- Note: For very few schools, the pct over one sub-group is greater than 100 - this mostly happens in the `idea` enrollment.  -->

<!-- ### Suspension Data set -->

```{r load suspension data and susset, eval = FALSE}
susp <- import(here("data", "Suspensions.csv")) %>%
    as_tibble() %>%
    clean_names() %>% 
    mutate(across(c(9:189), remove_neg))

#preK suspension data
susp_ps <- susp %>% 
  select(c(1:50)) 

#K12 suspension
susp_k12 <- susp %>% 
  select(c(1:8,51:167))

```

<!-- Tidy data for regression -->

```{r susp_sum, eval = FALSE}

#K-12 summary data
susp_sum <- susp_k12 %>% 
  select(combokey, matches('tot|_504_')) %>% 
  mutate(
    tot_susp = rowSums(across(where(is.numeric)), na.rm = TRUE)
  ) %>% 
  select(combokey, tot_susp)
  

```

<!-- ### School Support  -->

<!-- Import and Tidying -->

```{r load_support_data, eval = FALSE}
support<- read_csv(here("data", "School Support.csv")) %>%
  as_tibble() %>%
  clean_names() %>% 
  mutate(across(c(9:22),remove_neg)) %>% 
  mutate(sum_new_teachers = (sch_fteteach_sy + sch_fteteach_fy),
    pct_new_teachers = sum_new_teachers*100/sch_fteteach_tot, #should be sch_fteteach_tot instead of sch_teachers_curr_total
    tot_law = rowSums(select(., contains('_ftesecurity_')), na.rm = TRUE)
        )
support_sum <- support %>% 
  select(c(combokey, pct_new_teachers, sch_fteteach_tot, tot_law))

# Tidy data for descriptive analysis

support_tidy <- support %>% 
  pivot_longer(cols = -c(1:8,23,24),
               names_to = c("untidy1","detail1","detail2"),
               values_to = "count_teachers",
               names_prefix = "sch_",
               names_sep = "_"
  ) %>% 
  mutate(
    fte = case_when(
      str_detect(untidy1,"fte") ~ "Yes",
      TRUE ~ "No"
    ),
    untidy1 = str_remove(untidy1,"fte"),
    tot = case_when(
      str_detect(detail1,"tot") ~ "Yes",
      str_detect(detail2,"tot") ~ "Yes",
      TRUE ~ "No"
    ),
    detail1 = str_remove(detail1,"tot"),
    employee_category = untidy1,
  ) %>% 
  filter(tot == "Yes" & fte == "Yes") %>% 
  select(-c(detail2,detail1,untidy1,tot,fte,employee_category)) %>% 
  select(-c(1:6,8))


          
```


<!-- ### School Characteristics Tidying -->

```{r load and tidy characteristics, eval = FALSE}

sch_characteristics_raw <- import(here("data","School Characteristics.csv")) %>% 
  as_tibble() %>% 
  clean_names()

#function to change Yes to 1, and No to 0
helperFunction <- function(x){
    ifelse(x=="Yes", 1,0)
}

sch_characteristics <- sch_characteristics_raw %>%
  mutate(across(c(9:32),remove_neg)) %>% 
  select(combokey, c(27:30)) %>% 
  mutate(across(c(2:5),helperFunction))

 #Just pivoting longer and wider w/o any manipulation
# characteristics_tidy <- sch_characteristics %>% 
#   pivot_longer(cols = (8:12),
#                names_to = "type",
#                values_to = "status",
#                names_prefix = "sch_status_",
#                names_transform = list(
#     gender = ~ readr::parse_factor(.x, levels = c("f", "m")),
#     ) %>% 
#   pivot_wider(names_from = type,
#               values_from = status) %>% 
#   select(-(1:6))

```

<!-- ### Expulsion Data Set -->

```{r load expulsion data and subset, eval = FALSE}
expl <- import(here("data", "Expulsions.csv")) %>%
    as_tibble() %>%
    clean_names() %>% 
    mutate(across(c(9:142), remove_neg))

#preK expulsion data
expl_ps <- expl %>% 
  select(c(1:8), matches('psdisc')) 

#K12 data expulsion data
expl_k12 <- expl %>% 
  select(c(1:142), -matches('psdisc'))

```

<!-- Tidy data for regression -->

```{r expl_sum, eval = FALSE}

#K-12 summary data
expl_sum <- expl_k12  %>% 
  select(combokey, matches('tot|_504_')) %>% 
  mutate(
    tot_expl = rowSums(across(where(is.numeric)), na.rm = TRUE)
  ) %>% 
  select(combokey, tot_expl)
  
```

<!-- ### Referals and Arrest Data Set -->

```{r ra_sum, eval = FALSE}
ra_sum <- import(here("data", "Referrals and Arrests.csv")) %>%
    as_tibble() %>%
    clean_names() %>% 
    mutate(across(c(9:84), remove_neg)) %>% 
    select(combokey, matches('tot|_504_')) %>% 
    mutate(
    tot_ref = rowSums(select(., contains('_ref_')), na.rm = TRUE),
    tot_arr = rowSums(select(., contains('_arr_')), na.rm = TRUE)
    ) %>% 
  select(combokey, tot_ref, tot_arr)
```

<!-- ### Joined Data -->

```{r joined, eval = FALSE}
# Function to calculate rates per 1000 student
rate <- function(x) (x*1000 / enroll_final$tot_enr)

data_join <- enroll_final %>% 
  left_join(sch_characteristics, by = 'combokey') %>% 
  select(c(1:8, 55:58, 9, 11:15, 18:19, 17, 16, 10)) %>% 
  left_join(susp_sum, by = 'combokey') %>% 
  left_join(expl_sum, by = 'combokey') %>% 
  left_join(ra_sum, by = 'combokey') %>% 
  left_join(support_sum, by = 'combokey') %>%
  mutate(
  susp_std = rate(tot_susp),
  expl_std = rate(tot_expl),
  ref_std = rate(tot_ref),
  arr_std = rate(tot_arr),
  law_std = rate(tot_law)
  )



```


```{r export, eval = FALSE}
#export(data_join, here("data","data_join.csv"))
```



## Descriptive Findings {.tabset}

From the different data sets, we'll be creating some figures.


### Expulsions and Suspensions Cleaning

We'll be creating longer version for this data-set.


```{r load suspension and expulsion}
#Function to remove negative numbers from data

remove_neg <- function (x) ifelse(x < 0, NA, x)

susp <- import(here("data", "Suspensions.csv")) %>%
    as_tibble() %>%
    clean_names() %>% 
    mutate(across(c(9:189), remove_neg))

#preK suspension data
susp_ps <- susp %>% 
  select(c(1:50)) 

#K12 suspension
susp_k12 <- susp %>% 
  select(c(1:8,51:167))

expl <- import(here("data", "Expulsions.csv")) %>%
    as_tibble() %>%
    clean_names() %>% 
    mutate(across(c(9:142), remove_neg))

#preK expulsion data
expl_ps <- expl %>% 
  select(c(1:8), matches('psdisc')) 

#K12 data expulsion data
expl_k12 <- expl %>% 
  select(c(1:142), -matches('psdisc'))

```


```{r tidy data}

susp_k12_504 <- susp_k12 %>% 
        select(combokey, matches('_504_')) %>% 
        rename_with( ~ (gsub("_504_", "_all_", .x, fixed = TRUE))) %>% 
        rename_with( ~ (gsub("discwdis", "504", .x, fixed = TRUE)))

susp_k12_tidy <- susp_k12 %>% 
        select(-matches('tot|_504|oosinstances')) %>% 
        rename_with( ~ (gsub("_idea_", "_", .x, fixed = TRUE))) %>% 
        rename_with( ~ (gsub("discwdis", "idea", .x, fixed = TRUE))) %>% 
        left_join(susp_k12_504, by = "combokey") %>% 
        rename_with( ~ (gsub("discwodis", "no", .x, fixed = TRUE))) %>% 
        pivot_longer(
            cols = -c(1:8), 
            names_to = c("disability", "type","ethnicity/lep", "gender"),
            names_sep = "_",
            names_prefix = "sch_",
            values_to = "students",
        )

susp_ps_tidy <- susp_ps %>% 
        select(-matches('tot|oosinstances'))%>% 
        pivot_longer(
            cols = -c(1:8), 
            names_to = c("type", "ethnicity/lep/idea","gender"),
            names_sep = "_",
            names_prefix = "sch_psdisc_",
            values_to = "students" 
        )

expl_k12_504 <- expl_k12 %>% 
        select(combokey, matches('_504_')) %>% 
        rename_with( ~ (gsub("_504_", "_all_", .x, fixed = TRUE))) %>% 
        rename_with( ~ (gsub("discwdis", "504", .x, fixed = TRUE)))

expl_k12_tidy <- expl_k12 %>% 
        select(-matches('tot')) %>% 
        rename_with( ~ (gsub("_idea_", "_", .x, fixed = TRUE))) %>% 
        rename_with( ~ (gsub("discwdis", "idea", .x, fixed = TRUE))) %>% 
        left_join(expl_k12_504, by = "combokey") %>% 
        rename_with( ~ (gsub("discwodis", "no", .x, fixed = TRUE))) %>% 
        pivot_longer(
            cols = -c(1:8), 
            names_to = c("disability", "type","ethnicity/lep", "gender"),
            names_sep = "_",
            names_prefix = "sch_",
            values_to = "students",
        )

expl_ps_tidy <- expl_ps %>% 
        select(-matches('tot'))%>% 
        pivot_longer(
            cols = -c(1:8), 
            names_to = c("type", "ethnicity/lep/idea","gender"),
            names_sep = "_",
            names_prefix = "sch_psdisc_",
            values_to = "students" 
        )

```

# Methods

This analysis was conducted using publicly available data from the 2017-18 civil rights data collection. Each biennium, schools across the United States are required to respond and report key information about their school. This includes enrollment information, levels of school personnel, incidents of exclusionary discipline, harassment, and bullying.

## Sample and Exclusion Criteria

The sample in this study included K-12 schools across the United States. Overall, the 2017-18 civil rights data collection contains XXX schools who serve students in Grades K-12. {Add information about cleanings steps - what we did with missing data and 0s}  Schools categorized **{update when we figure out which schools are excluded** were excluded from the analysis.  The final sample included XX schools across the United States. Table 1 summarizes information on the study sample (see table x in the appendix). 

## Add descriptive statistics table

## Study Variables
The main predictor variable for research question one was the percent of teachers that are novice teachers at a school. This variable was calculated by dividing the number of novice teachers at a school by the total number of full time teachers. Across schools in our sample, the mean rate of novice teachers was X, and the numbers ranged from X to X. The main predictor of interest for research question two was the number of security personnel (sworn law enforcement officers and other security personnel) per 1000 students Across the school sample, the average rate of security personnel was X per 1000 students.

The analysis had three outcomes of interest that broadly examined school climate — one for research question one and two for RQ2. For research question 1, the main outcome of interest was the rate of students who received a suspension. More specifically, this variable was defined as the number of suspended students per 1000 students at a school. For research question 2, the two variables of interest were rates of harassment/bullying and rates of referrals and arrests. Rate of harassment and bulling was defined as the number of students per 1000 students who were disciplined for harassment/bullying. Rate of referral/arrests was defined as the number of students per 1000 students who received a referral or were arrested.

## Analytic Approach
Descriptive statistics and regression analysis were used to answer the two research questions. 

To answer the first research question, we used a 3-level hierarchical linear model with schools nested within districts and districts nested within states. The final model is represented by the following sets of equations. 
Y_jks= π_0ks+X_j+ 〖γ1〗_j Noviceteachers+ ε_jks
π_ks=β_00s+ r_0jk 
β_00s= γ_000+ μ_00k
Where the outcome (Y) of school (j) in district (k) in state (s) is predicted by a set of school level enrollment covariates (X_j) and a school level measure of counselor caseload. The γ1 coefficient represents the relationship between counselor caseload and study outcomes and addresses the first research question.

To answer the second research question...

# Results

## Descriptive Statistics Summary 

```{r}
dat <- import(here("data", "data_join.csv")) %>% 
  select(lea_state_name, lea_name, sch_name, starts_with("tot"))
dat %>% tbl_summary()
```



## Research Question 1 - Rates of Novice Teachers and Suspensions

Rates of novice teachers was positively and statistically significantly associated with higher rates of suspensions. Across schools in the United States, the average rate of suspension was 104 students per 1000 students at typical schools (e.g. not an alternative school) with average rates of total enrollment and average rates of enrollment by race/ethnicity, EL students, and special education enrollment. A one percentage point increase in the rate of novice teachers increased the number of students suspended per 1000 by 1. 

```{r }
#Importing the file and doing some cleaning to  make sure it runs, dropping Puerto Rico because they don't appear to report suspensions -rates were zero. 
#This throws error for me because of space. Guess we have a lot of data loaded in the prev. chunks
rq1 <- import(here("data","data_join.csv")) %>%
  as_tibble() %>%
  filter(lea_state != "PR") %>%
  mutate(leaid = as.numeric(leaid),
         lea_state = as.factor(lea_state)) %>%
  filter(!is.na(susp_std)) %>%
  filter(!is.na(pct_new_teachers)) %>%
  filter(pct_new_teachers != Inf) %>%
  mutate(pct_new_teachers = ifelse(pct_new_teachers > 100,100, pct_new_teachers))

```

Explore the extent to which rate of novice teachers and rate of suspensions vary
across states. Appears to have wide variation within state and across states.

```{r }
#Creating a data frame with state averages and using this to plot district rates
state_means <- rq1 %>% 
  group_by(lea_state) %>% 
  summarise(state_mean_susp = mean(susp_std,weights = tot_enr, na.rm = TRUE),
            state_mean_susp_se = sd(susp_std, na.rm = TRUE)/sqrt(n()),
            state_mean_newtch = mean(pct_new_teachers,weights = tot_enr, na.rm = TRUE),
            state_mean_newtch_se = sd(pct_new_teachers, na.rm = TRUE)/sqrt(n()),
            ) 

#Rate of Novice teachers across states
state_means %>%  
  mutate(lea_state = reorder(lea_state,state_mean_newtch)) %>%
  ggplot(aes(state_mean_newtch, lea_state)) +
    geom_point(color = "#0aadff")  +
    geom_vline(xintercept = mean(rq1$pct_new_teachers, na.rm = TRUE),
             color = "red",
             size = 1) +
  geom_errorbarh(aes(xmin = state_mean_newtch - 1.96*state_mean_newtch_se,
                     xmax = state_mean_newtch+ 1.96*state_mean_newtch_se)) +
  labs( y = "State", x = "Percent novice teachers") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text=element_text(size=8))

#Rate of Suspensions expulsion across States
state_means %>%  
  mutate(lea_state = reorder(lea_state,state_mean_susp)) %>%
  ggplot(aes(state_mean_susp, lea_state)) +
    geom_point(color = "#0aadff")  +
    geom_vline(xintercept = mean(rq1$susp_std, na.rm = TRUE),
             color = "red",
             size = 1) +
  geom_errorbarh(aes(xmin = state_mean_susp - 1.96*state_mean_susp_se,
                     xmax = state_mean_susp+ 1.96*state_mean_susp_se)) +
  labs( y = "State", x = "Mean rate of student suspensions per 1000") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text=element_text(size=6))

```

Explore the visual relationship between percent new teachers and rates of suspension. It looks like it is a positive relationship. As the percent of new teachers increases, the rate of suspension increases. Looking at this by state, it looks like starting point (intercept) and the slope between these two variables vary. Some states have steeper slopes or start higher. Indicates need for a hierchichal linear model.

```{r }
# Rate of suspensions per 1000 students across states
# Explore the relationship between novice teachers and rate of suspension
rq1 %>%
  ggplot(aes(x = pct_new_teachers, y = susp_std)) +
    geom_point() +   
    geom_smooth(method = lm)
         
#When looking at regression lines by state, we see different intercepts and slopes of relationship
rq1 %>%
  ggplot(aes(x = pct_new_teachers, y = susp_std, color = lea_state)) +
  geom_smooth(method = lm, se = FALSE) + theme(legend.position="none")

```

```{r }

# As part of the analysis, conducted 4 models that explored the relationship between percent new teachers and rate of suspensions. The first model only included the variable of interest as a control with random intercepts for district and state. The second model added enrollment covariates and school characteristics with random intercepts. The third model allowed the relationship between percent new teachers and rate of suspension to vary across districts. The last model included interactions between enrollment and percent new teachers. Model comparison tests found that the third model was the best model. 
# 
# Results from the analysis indicates that a one percentage point increase in rate of novice teachers is associated with an increase of 1 student suspended per 1000 students, while accounting for other enrollment and school characteristics. This relationship was statistically significant (p <.001).

#Mean Center the variables
rq1 <- rq1 %>%
  mutate(pct_new_teachers_c = pct_new_teachers - mean(pct_new_teachers),
            tot_enr_c = tot_enr - mean(tot_enr),
         sch_enr_am_c = sch_enr_am - mean(sch_enr_am),
         sch_enr_as_c = sch_enr_as - mean(sch_enr_as),
         sch_enr_bl_c = sch_enr_bl - mean(sch_enr_bl),
         sch_enr_hi_c = sch_enr_hi - mean(sch_enr_hi),
         sch_enr_hp_c = sch_enr_hp - mean(sch_enr_hp),
         sch_enr_tr_c = sch_enr_tr - mean(sch_enr_tr),
         sch_enr_wh_c = sch_enr_wh - mean(sch_enr_wh),
         sch_enr_lep_c = sch_enr_lep - mean(sch_enr_lep),
         sch_enr_idea_c = sch_enr_idea - mean(sch_enr_idea),
         tot_law_c = tot_law - mean(tot_law)
  )


#Null model
rq1_m0 <- lmer(susp_std ~ pct_new_teachers_c + (1 | leaid) + (1 | lea_state), 
               data = rq1, na.action = na.pass)

#Model with covariates and random intercepts
rq1_m1 <- lmer(susp_std ~ pct_new_teachers_c + tot_enr_c + sch_enr_am_c + sch_enr_as_c + 
                 sch_enr_bl_c + sch_enr_hi_c + sch_enr_hp_c + sch_enr_tr_c + 
                 sch_enr_lep_c + sch_enr_idea_c + sch_status_sped + 
                 sch_status_magnet + sch_status_charter + sch_status_alt + tot_law_c +
                 (1 | leaid) + (1 | lea_state), 
               data = rq1)

#Model with covariates, random intercepts, and random slopes - no interactions
rq1_m2 <- lmer(susp_std ~ pct_new_teachers_c + tot_enr_c + sch_enr_am_c + sch_enr_as_c + 
                 sch_enr_bl_c + sch_enr_hi_c + sch_enr_hp_c + sch_enr_tr_c + 
                 sch_enr_lep_c + sch_enr_idea_c + sch_status_sped + 
                 sch_status_magnet + sch_status_charter + sch_status_alt + tot_law_c +
                 (pct_new_teachers_c | leaid) + (1 | lea_state), 
               data = rq1)

#Model with covariates, random intercepts,random slopes and interactions
rq1_m3 <- lmer(susp_std ~ pct_new_teachers_c + tot_enr_c + sch_enr_am_c + sch_enr_as_c + 
                 sch_enr_bl_c + sch_enr_hi_c + sch_enr_hp_c + sch_enr_tr_c + 
                 sch_enr_lep_c + sch_enr_idea_c + sch_status_sped + 
                 sch_status_magnet + sch_status_charter + sch_status_alt + tot_law_c +
                 pct_new_teachers:sch_enr_bl + pct_new_teachers:sch_enr_idea +
                 (pct_new_teachers_c | leaid) + (1 | lea_state), 
               data = rq1)
# Checking model performance
compare_performance(rq1_m0,rq1_m1,rq1_m2,rq1_m3, rank = TRUE) %>%
  print_md()


tab_model(rq1_m0,rq1_m1,rq1_m2,rq1_m3, collapse.ci = TRUE, p.style = "stars",
          dv.labels = c("Model 1 - Random Intercepts for states and districts, No covariates", "Model 2 - Random Intercepts for districts, with covariates", 
                      "Model 3 - Random Intercepts for schools and districts, \n\ random slope of novice teachers across districts", 
                      "Model 4 - Random Intercepts for schools and districts, \n\ random slope of novice teachers across districts and \n\ enrollment interactions"),
          pred.labels = c("Intercept", "Percent New Teachers", "Total Enrollment",
                        "Percent American Indian", "Percent Asian",
                        "Percent Black", "Percent Latinx", 
                        "Percent Hawaiian/Pacific Islander",
                        "Percent Multiracial", "Percent EL Classified", 
                        "Percent Special Ed.",
                        "Special Ed School (Y/N)", "Magnet school ((Y/N)", 
                        "Charter School (Y/N)", "Alternative School (Y/N)",
                        "Total law enforcement officers",
                        "Percent New Teachers X Black Enrollment", 
                        "Percent New Teachers X Special Education"))

results <- plot_coefs(rq1_m0,rq1_m1,rq1_m2,rq1_m3, coefs = c(" " = "pct_new_teachers_c"),
           model.names = c("Model 1 - Random Intercepts for districts and states,\n\ no covariates", "Model 2 - Random Intercepts for districts and states,\n\ with covariates", 
                      "Model 3 - Random Intercepts for districts and states, \n\ random slope of novice teachers across districts", 
                      "Model 4 - Random Intercepts for districts and states, \n\ random slope of novice teachers across districts and \n\ enrollment interactions"),
           legend.title = "Models",
           ci.level = .5,
           robust = FALSE,
           point.shape = FALSE)
           
results + labs(x = "Change in number of students suspended per 1,000 students \n\ for every percentage point increase in the rate of novice teachers") + xlim(-1,2) + theme(axis.text=element_text(size=10), legend.text=element_text(size = 10))
```

## Research Question 1 - Descriptive Results. (Merly add graphs and description)

### Suspension rate by ethnicity in preschool
```{r}
susp_ps_tidy %>% 
  filter(`ethnicity/lep/idea` != "lep" ,
         `ethnicity/lep/idea` != "idea" ) %>% 
  mutate(`ethnicity/lep/idea` = factor(`ethnicity/lep/idea`,
                                        levels = c("as", "hp", "am", "tr", "hi", "wh", "bl")))%>% 
ggplot(aes(fill = `ethnicity/lep/idea`, 
           x = type, 
           y =students)) + 
  geom_col(position = "fill",
               stat = "identity", 
           alpha = 0.7, na.rm = TRUE) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Suspension Rate by Ethnicity in Preschool",
       fill = "Ethnicity",
       x = "Type of Suspensions") + 
  theme(text = element_text(size = 30, face = "bold"))
ggsave(here("plot", "susp_ps.jpg"))
```
### Suspension rate by Ethnicity in k12

```{r}
susp_k12_tidy %>% 
  drop_na() %>% 
  filter(`ethnicity/lep` != "lep",
         `ethnicity/lep` != "all",
         type == "singoos"|
         type == "multoos"
         ) %>% 
    mutate(`ethnicity/lep` = 
             fct_relevel (`ethnicity/lep`, "as", "hp", "am","tr", "hi", "wh","bl")) %>% 
  ggplot(aes(fill = `ethnicity/lep`,
             x = type, 
             y = students)) + 
geom_col(position = "fill",
         stat = "identity",
           alpha = 0.7, na.rm = TRUE) +
scale_fill_brewer(palette = "Set1") +
labs(title = "Suspension Rate by Ethnicity in K12",
       fill = "Ethnicity",
       x = "Type of Suspensions",
       y = "Number of Students") + 
theme(text = element_text(size = 30, face = "bold"))
ggsave(here("plot", "susp_k12.jpg"))


```
  * Multiple Out of school suspension rate by gender and race for preschool students
```{r}
susp_ps_tidy %>% 
  filter(type == "multoos",
         `ethnicity/lep/idea` != "lep" ,
         `ethnicity/lep/idea` != "idea" ) %>% 
  mutate(`ethnicity/lep/idea` = 
             fct_relevel (`ethnicity/lep/idea`, "as", "hp", "am","tr", "hi", "wh","bl"))%>% 
  ggplot(aes(`ethnicity/lep/idea`, students)) +
  geom_col(aes(fill = gender),
           position = "dodge",
           na.rm = TRUE) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Multiple Out-of-school Suspension by Ethnicity & Gender in Preschool",
       fill = "Gender",
       x = "Multiple Out-of-School Suspensions",
       y = "Number of Students") + 
  theme(text = element_text(size = 30, face = "bold"))
ggsave(here("plot", "susp_ps.jpg"))

```

* Multiple Out of school suspension rate by gender and race for k12 students
```{r}
susp_k12_tidy %>% 
filter(type == "multoos",
         `ethnicity/lep` != "lep",
         `ethnicity/lep` != "all"
         ) %>% 
mutate(`ethnicity/lep/` = factor(`ethnicity/lep`,
                                   levels = c("as", "hp",
                                              "am","tr","wh", "hi",
                                              "bl"))) %>% 
ggplot(aes(fill = gender,
           x = `ethnicity/lep`, 
           y = students)) +
geom_col( position = "dodge") + 
scale_fill_brewer(palette = "Set1") +
labs(
  title = "Multiple Out-of-school Suspension by Ethnicity & Gender in K12",
  fill = "Gender",
  x = "Type of Suspensions",
  y = "Number of Students") + 
theme(text = element_text(size = 30, face = "bold"))
ggsave(here("plot", "susp_ps.jpg"))
  
```
The graphs of Suspensions rate by Ethnicity show that Black Students are being suspended more compared to their peers in Preschool and K-12. When gender is included, the graphs show that both Black Male and Black Female students are being suspended more compared to their peers in Preschool and K-12. 


### Arrest and Referrals

We'll add some figures here.

### Joined Data

We'll add some figures here.


\newpage
## Research Question 2 results
```{r}
#getwd()
```

Tidying Data Sets for Multiple Regression
```{r}
ra_final %>%
  colnames ()
```

Changed "Not Reported" data to NA; checked that code worked by searching for the phrase in the view data pane
ra_reg = ra_final data set down-sized & tidied for regression analysis
```{r}
ra_reg <- ra_final %>%
select(lea_state, lea_state_name, leaid, lea_name, schid, sch_name, combokey, jj, enroll_all, starts_with("tot"), sch_ftesecurity_leo, sch_ftesecurity_gua) %>%
  set_na(na = c("Not Reported"))

ra_reg
```

```{r}
# library(readr)

urlfile = "https://raw.githubusercontent.com/merlyklaas/final_project/master/data/data_join.csv"

joinD <- read.csv(url(urlfile))
```

```{r}
# export(joinD, here("data", "joinD.xlsx"))
```

```{r}
joinD %>%
  colnames ()
```

```{r}
ra_reg %>%
  colnames ()
```

ra_D merges the main arrest/referral data set with the joined data set
```{r}
ra_D <- merge(x = ra_reg, y = joinD [, c(8, 26:28, 30, 33:35)], by = "combokey", all.x = TRUE)

ra_D
```

```{r}
ra_D %>%
  colnames ()
```

280 population size for Alabama Youth Services LEA only
Total population size for data set is below
```{r}
  sum(ra_D$enroll_all, na.rm=TRUE)
```

Changed _gua variable from character to numeric
```{r}
ra_reg$sch_ftesecurity_gua <- as.numeric(ra_reg$sch_ftesecurity_gua)
```

```{r}
class(ra_reg$sch_ftesecurity_gua)
```
This is the problem code that creates a 216911 under _gua
```{r}
ra_tidy <- ra_reg %>%
  group_by(leaid) %>%
  summarise(wodis_ref_m = sum(tot_discwodis_ref_m),
            wodis_ref_f = sum(tot_discwodis_ref_f),
            wdis_ref_idea_m = sum(tot_discwdis_ref_idea_m),
            wdis_ref_idea_f = sum(tot_discwdis_ref_idea_f),
            wodis_arr_m = sum(tot_discwodis_arr_m),
            wodis_arr_f = sum(tot_discwodis_arr_f),
            wdis_arr_idea_m = sum(tot_discwdis_arr_idea_m),
            wdis_arr_idea_f = sum(tot_discwdis_arr_idea_f),
            sum_leo = sum(sch_ftesecurity_leo, na.rm=TRUE), 
            sum_gua = sum(sch_ftesecurity_gua, na.rm=TRUE))

ra_tidy
```

```{r}
# export(ra_tidy, here("data", "ra_tidy.xlsx"))
```

```{r}
# export(ra_tidy2_c, here("data", "ra_tidy2_c.xlsx"))
```

```{r}
ra_tidy2 <- ra_tidy %>%
  mutate(total_law = sum_leo + sum_gua) %>%
  select(!starts_with("sum"))

ra_tidy2
```

Collapsing for histogram
total_student = total number of students with a disciplinary action
```{r}
ra_tidy2_c <- ra_tidy2 %>%
  mutate(total_student = wodis_ref_m + wodis_ref_f + wdis_ref_idea_m + wdis_ref_idea_f + wodis_arr_m + wodis_arr_f + wdis_arr_idea_m + wdis_arr_idea_f)
  
ra_tidy2_c
```

Excluding LEA ID 4816620 as an outlier
```{r}
ratc <- ra_tidy2_c %>%
  filter(leaid != "4816620")

ratc
```

ratc (ra tidy2 collapsed - no outlier)
```{r}
ratc %>%
  describeBy()
```

How to label this graph with LEA IDs and make easier to read?
Drop school district with NAs and 0s
keep top 10 and bottom 10 to see variation
similar graph with law officers
```{r fig3, fig.height = 10, fig.width = 10, fig.align = "center"}
ratc %>%
ggplot(aes(as.factor(x = leaid), y = total_student)) +
geom_col(width = 0.3)+
theme_minimal() +
  coord_flip()
```

```{r}
ggplot(ratc, aes(total_law, total_student)) +
  geom_point() +
  theme_minimal() +
  labs(x = "Total Number of Law Enforcement Officials",
    y = "Total Number of Students with a Disciplinary Action")
```


```{r}
ra_tidy3 <- ra_tidy2 %>%
  pivot_longer(cols = 2:9,
    names_to = "student_type",
    values_to = "tot_st")
  
ra_tidy3
```

```{r}
ra_tidy4 <- ra_tidy3 %>%
  group_by(leaid) %>%
  mutate_at("student_type", str_replace, "_idea", "") %>%
  separate(student_type, c("status", "dis_act", "gender"), "_") %>%
  filter(leaid != "4816620")

ra_tidy4
```

#Multiple Regression
Convert gender, disciplinary action, and disability status variables from characters to numeric factors.
```{r}
ra_tidy4$gender <- factor(ra_tidy4$gender)
```

```{r}
levels(ra_tidy4$gender)
```

```{r}
contrasts(ra_tidy4$gender)
```

```{r}
ra_tidy4$status <- factor(ra_tidy4$status)
```

```{r}
levels(ra_tidy4$status)
```

```{r}
contrasts(ra_tidy4$status)
```

```{r}
ra_tidy4$dis_act <- factor(ra_tidy4$dis_act)
```

```{r}
ra_tidy4$tot_st <- as.numeric(ra_tidy4$tot_st)
```

Check data structure
```{r}
str(ra_tidy4)
```

```{r}
colnames(ra_tidy4)
```

## Summary of variables:
* leaid: The LEA's (school district) ID number.
* total_law: The total number of FTE (full time equivalent) law enforcement officials (security guards + law enforcement officers).
* status: A student's disability status, either wodis = without disability or wdis = with disability.
* dis_act: The disciplinary action taken (either an arrest or a referral).
* gender: The student's biological gender (male or female).
* tot_st: The total number of students in the LEA with a dis_act.

```{r}
  describeBy(ra_tidy4[, -1])
```

Research hypothesis: The total number of disciplinary actions is related to the total number of law enforcement officials. A regression model will be run with total_law as a predictor of tot_st while controlling for gender and disability status.

Correlation between tot_st and total_law?
```{r}
# corr.t <- corr.test(ra_tidy4[, c(2,5)],use="pairwise.complete.obs")

# round(cor.mat,3)
```

Could this clustering effect in the corner of the graph be due to disctricts with NA or 0?
```{r}
scatterHist(tot_st ~ total_law,
  data = ra_tidy4,
  smooth=FALSE,
  ab=FALSE,
  correl=FALSE,
  ellipse=FALSE,
  xlab = "Total Number of Students with a Disciplinary Action",
  ylab = "Total Number of Law Enforcement Officials",
  pch=19,
  title = "Relationship between Law Enforcement and Students with Actions")
```


###Results
Add a control for total student population size
```{r}
mod <- lm(tot_st ~ 1 + total_law + gender + status, data=ra_tidy4)

require(car)

Anova(mod,type=3)

summary(mod)
```

```{r}
library(sjPlot)
tab_model(mod)
```

<<<<<<< Updated upstream
=======




# Results

## Research Quesiton 1

```{r}

#This throws error for me because of space. Guess we have a lot of data loaded in the prev. chunks

rq1 <- import(here("data","data_join.csv")) %>%
  as_tibble() %>%
  mutate(leaid = as.numeric(leaid),
         lea_state = as.factor(lea_state)) %>%
  filter(!is.na(susp_std)) %>%
  filter(!is.na(pct_new_teachers)) %>%
<<<<<<< Updated upstream
  filter(pct_new_teachers != Inf) %>%
  mutate(pct_new_teachers = ifelse(pct_new_teachers > 100,100, pct_new_teachers))

```

Explore the extent to which rate of novice teachers and rate of suspensions vary
across states. Appears to have wide variation within state and across states.

```{r }
#Creating a data frame with state averages and using this to plot district rates
state_means <- rq1 %>% 
  group_by(lea_state) %>% 
  summarise(state_mean_susp = mean(susp_std,weights = tot_enr, na.rm = TRUE),
            state_mean_susp_se = sd(susp_std, na.rm = TRUE)/sqrt(n()),
            state_mean_newtch = mean(pct_new_teachers,weights = tot_enr, na.rm = TRUE),
            state_mean_newtch_se = sd(pct_new_teachers, na.rm = TRUE)/sqrt(n()),
            ) 

#Rate of Novice teachers across states
state_means %>%  
  mutate(lea_state = reorder(lea_state,state_mean_newtch)) %>%
  ggplot(aes(state_mean_newtch, lea_state)) +
    geom_point(color = "#0aadff")  +
    geom_vline(xintercept = mean(rq1$pct_new_teachers, na.rm = TRUE),
             color = "red",
             size = 1) +
  geom_errorbarh(aes(xmin = state_mean_newtch - 1.96*state_mean_newtch_se,
                     xmax = state_mean_newtch+ 1.96*state_mean_newtch_se)) +
  labs( y = "State", x = "Percent novice teachers") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text=element_text(size=8))

#Rate of Suspensions expulsion across States
state_means %>%  
  mutate(lea_state = reorder(lea_state,state_mean_susp)) %>%
  ggplot(aes(state_mean_susp, lea_state)) +
    geom_point(color = "#0aadff")  +
    geom_vline(xintercept = mean(rq1$susp_std, na.rm = TRUE),
             color = "red",
             size = 1) +
  geom_errorbarh(aes(xmin = state_mean_susp - 1.96*state_mean_susp_se,
                     xmax = state_mean_susp+ 1.96*state_mean_susp_se)) +
  labs( y = "State", x = "Mean rate of student suspensions per 1000") +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
  panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text=element_text(size=6))

```

Explore the visual relationship between percent new teachers and rates of suspension. It looks like it is a positive relationship. As the percent of new teachers increases, the rate of suspension increases. Looking at this by state, it looks like starting point (intercept) and the slope between these two variables vary. Some states have steeper slopes or start higher. Indicates need for a hierchichal linear model.

```{r }
# Rate of suspensions per 1000 students across states
# Explore the relationship between novice teachers and rate of suspension
rq1 %>%
  ggplot(aes(x = pct_new_teachers, y = susp_std)) +
    geom_point() +   
    geom_smooth(method = lm)
         
#When looking at regression lines by state, we see different intercepts and slopes of relationship
rq1 %>%
  ggplot(aes(x = pct_new_teachers, y = susp_std, color = lea_state)) +
  geom_smooth(method = lm, se = FALSE) + theme(legend.position="none")

```



# Results

## Rates of Novice Teachers and Suspensions

Rates of novice teachers was positively and statistically significantly associated with higher rates of suspensions. Across schools in the United States, the average rate of suspension was 104 students per 1000 students at typical schools (e.g. not an alternative school) with average rates of total enrollment and average rates of enrollment by race/ethnicity, EL students, and special education enrollment. A one percentage point increase in the rate of novice teachers increased the number of students suspended per 1000 by 1. 

```{r }

# As part of the analysis, conducted 4 models that explored the relationship between percent new teachers and rate of suspensions. The first model only included the variable of interest as a control with random intercepts for district and state. The second model added enrollment covariates and school characteristics with random intercepts. The third model allowed the relationship between percent new teachers and rate of suspension to vary across districts. The last model included interactions between enrollment and percent new teachers. Model comparison tests found that the third model was the best model. 
# 
# Results from the analysis indicates that a one percentage point increase in rate of novice teachers is associated with an increase of 1 student suspended per 1000 students, while accounting for other enrollment and school characteristics. This relationship was statistically significant (p <.001).

#Mean Center the variables
rq1 <- rq1 %>%
  mutate(pct_new_teachers_c = pct_new_teachers - mean(pct_new_teachers),
            tot_enr_c = tot_enr - mean(tot_enr),
         sch_enr_am_c = sch_enr_am - mean(sch_enr_am),
         sch_enr_as_c = sch_enr_as - mean(sch_enr_as),
         sch_enr_bl_c = sch_enr_bl - mean(sch_enr_bl),
         sch_enr_hi_c = sch_enr_hi - mean(sch_enr_hi),
         sch_enr_hp_c = sch_enr_hp - mean(sch_enr_hp),
         sch_enr_tr_c = sch_enr_tr - mean(sch_enr_tr),
         sch_enr_wh_c = sch_enr_wh - mean(sch_enr_wh),
         sch_enr_lep_c = sch_enr_lep - mean(sch_enr_lep),
         sch_enr_idea_c = sch_enr_idea - mean(sch_enr_idea),
         tot_law_c = tot_law - mean(tot_law)
  )


#Null model
rq1_m0 <- lmer(susp_std ~ pct_new_teachers_c + (1 | leaid) + (1 | lea_state), 
               data = rq1, na.action = na.pass)

#Model with covariates and random intercepts
rq1_m1 <- lmer(susp_std ~ pct_new_teachers_c + tot_enr_c + sch_enr_am_c + sch_enr_as_c + 
                 sch_enr_bl_c + sch_enr_hi_c + sch_enr_hp_c + sch_enr_tr_c + 
                 sch_enr_lep_c + sch_enr_idea_c + sch_status_sped + 
                 sch_status_magnet + sch_status_charter + sch_status_alt + tot_law_c +
                 (1 | leaid) + (1 | lea_state), 
               data = rq1)

#Model with covariates, random intercepts, and random slopes - no interactions
rq1_m2 <- lmer(susp_std ~ pct_new_teachers_c + tot_enr_c + sch_enr_am_c + sch_enr_as_c + 
                 sch_enr_bl_c + sch_enr_hi_c + sch_enr_hp_c + sch_enr_tr_c + 
                 sch_enr_lep_c + sch_enr_idea_c + sch_status_sped + 
                 sch_status_magnet + sch_status_charter + sch_status_alt + tot_law_c +
                 (pct_new_teachers_c | leaid) + (1 | lea_state), 
               data = rq1)

#Model with covariates, random intercepts,random slopes and interactions
rq1_m3 <- lmer(susp_std ~ pct_new_teachers_c + tot_enr_c + sch_enr_am_c + sch_enr_as_c + 
                 sch_enr_bl_c + sch_enr_hi_c + sch_enr_hp_c + sch_enr_tr_c + 
                 sch_enr_lep_c + sch_enr_idea_c + sch_status_sped + 
                 sch_status_magnet + sch_status_charter + sch_status_alt + tot_law_c +
                 pct_new_teachers:sch_enr_bl + pct_new_teachers:sch_enr_idea +
                 (pct_new_teachers_c | leaid) + (1 | lea_state), 
               data = rq1)
# Checking model performance
compare_performance(rq1_m0,rq1_m1,rq1_m2,rq1_m3, rank = TRUE) %>%
  print_md()


tab_model(rq1_m0,rq1_m1,rq1_m2,rq1_m3, collapse.ci = TRUE, p.style = "stars",
          dv.labels = c("Model 1 - Random Intercepts for states and districts, No covariates", "Model 2 - Random Intercepts for districts, with covariates", 
                      "Model 3 - Random Intercepts for schools and districts, \n\ random slope of novice teachers across districts", 
                      "Model 4 - Random Intercepts for schools and districts, \n\ random slope of novice teachers across districts and \n\ enrollment interactions"),
=======
  filter(pct_new_teachers != Inf)

control <- c("tot_enr","sch_enr_am", "sch_enr_as", "sch_enr_bl", "sch_enr_hi",
             "sch_enr_hp", "sch_enr_tr","sch_enr_wh","sch_enr_lep","sch_enr_idea",
             "sch_status_sped","sch_status_magnet", "sch_status_charter","sch_status_alt")
rq1_m0 <- lmer(susp_std ~ pct_new_teachers + (1 | leaid) + (1 | lea_state), 
               data = rq1, na.action = na.pass)

lm(susp_std ~ pct_new_teachers, data = rq1 )

rq1_m1 <- lmer(susp_std ~ pct_new_teachers + tot_enr + sch_enr_am + sch_enr_as + 
                 sch_enr_bl + sch_enr_hi + sch_enr_hp + sch_enr_tr + sch_enr_wh + 
                 sch_enr_wh + sch_enr_lep + sch_enr_idea + sch_status_sped + 
                 sch_status_magnet + sch_status_charter + sch_status_alt + 
                 (1 | leaid) + (1 | lea_state), 
               data = rq1)

tab_model(rq1_m0, rq1_m1, collapse.ci = TRUE, p.style = "stars",
>>>>>>> Stashed changes
          pred.labels = c("Intercept", "Percent New Teachers", "Total Enrollment",
                        "Percent American Indian", "Percent Asian",
                        "Percent Black", "Percent Latinx", "Percent Hawaiian/Pacific Islander",
                        "Percent Multiracial", "Percent EL Classified", "Percent Special Ed.",
                        "Special Ed School (Y/N)", "Magnet school ((Y/N)", 
<<<<<<< Updated upstream
                        "Charter School (Y/N)", "Alternative School (Y/N)",
                        "Total law enforcement officers",
                        "Percent New Teachers X Black Enrollment", 
                        "Percent New Teachers X Special Education"))

results <- plot_coefs(rq1_m0,rq1_m1,rq1_m2,rq1_m3, coefs = c(" " = "pct_new_teachers_c"),
           model.names = c("Model 1 - Random Intercepts for districts and states,\n\ no covariates", "Model 2 - Random Intercepts for districts and states,\n\ with covariates", 
                      "Model 3 - Random Intercepts for districts and states, \n\ random slope of novice teachers across districts", 
                      "Model 4 - Random Intercepts for districts and states, \n\ random slope of novice teachers across districts and \n\ enrollment interactions"),
           legend.title = "Models",
           ci.level = .5,
           robust = FALSE,
           point.shape = FALSE)
           
results + labs(x = "Change in number of students suspended per 1,000 students \n\ for every percentage point increase in the rate of novice teachers") + xlim(-1,2) + theme(axis.text=element_text(size=10), legend.text=element_text(size = 10))
=======
                        "Charter School (Y/N)", "Alternative School (Y/N)"))
>>>>>>> Stashed changes
```

>>>>>>> Stashed changes
# Discussion

# References

# Appendix

