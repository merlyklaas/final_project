---
title: "School Personnel and School Climate"
author: "TEAM QRME"
date: "11/10/2021"
output: 
    html_document:
        toc_flot: true
        toc_depth: 3
        highlight: pygments
        code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      error = FALSE,
                      fig.width = 9, 
                      fig.height = 9)

# Add your packages that you need here. This will load the libraries
#removed purr - part of tidyverse
#let's only include libraries we are using so that others don't have to install the irrelevant ones 
if (!require("pacman")) install.packages("pacman") 
#pacman::p_load(tidyverse, rio, here, ggridges, readr, ggthemes, sandwich, pracma, lme4,equatiomatic, performance, jtools, sundry,naniar,stargazer,vtable, reshape2, skimr, rddtools,tidylog,janitor) 
pacman::p_load(tidyverse, rio, here, ggridges, ggthemes, skimr, tidylog, janitor, reshape2, psych) 

library(rio)
library(dplyr)
library(here)
library(tidyr)
# install.packages(naniar)
library(naniar)
library(readr)
library(magrittr)
# install.packages(sjmisc)
library(sjmisc)
library(skimr)
library(janitor)
library(ggplot2)
library(tidyverse)
library(psych)
library(tinytex)
library(crayon)
library(ggthemes)
```

# Abstract

# Introduction 

## Cleaning different files {.tabset}

### School Enrollment Cleaning

In this section, I will import the enrollment file and subset it to keep relevant variables. This file will be the base file. 

```{r }
#Importing the Enrollment file
enroll<- read_csv(here("data", "Enrollment.csv")) %>%
  as_tibble() %>%
  subset(select = -c(9:31))
```

Exploring the file - I notice that there are some minimum values that are less than
zero, negative values don't make sense for enrollment. Need to replace those to 
missing.

```{r }
skim(enroll)
``` 


First, need to replace values that have negative values with a missing value, then
creating enrollment counts for race/ethnicity groups as well as EL and SPED.

```{r }
enroll <- enroll %>%
  mutate_all(~replace(., . < 0, NA)) %>%
  mutate(enroll_all = TOT_ENR_M + TOT_ENR_F,
         enroll_latinx = SCH_ENR_HI_M + SCH_ENR_HI_F,
         enroll_aian = SCH_ENR_AM_M + SCH_ENR_AM_F,
         enroll_asianam = SCH_ENR_AS_M + SCH_ENR_AS_F,
         enroll_nhpi = SCH_ENR_HP_M + SCH_ENR_HP_F,
         enroll_black = SCH_ENR_BL_M + SCH_ENR_BL_F,
         enroll_white = SCH_ENR_WH_M + SCH_ENR_WH_F,
         enroll_twomore = SCH_ENR_TR_M + SCH_ENR_TR_F,
         enroll_el = SCH_ENR_LEP_M + SCH_ENR_LEP_F,
         enroll_elserv = TOT_LEPPROGENR_M + TOT_LEPPROGENR_F,
         enroll_sped = SCH_ENR_IDEA_M + SCH_ENR_IDEA_F)
```

Checking to see if the code worked by checking the distribution of all the variables. 
In theory, none should go below zero in these box graphs. Based on the results, it appears
as if this worked out well 

```{r }
enroll %>% 
  melt(id.vars = "SCH_NAME", 
       measure.vars = c("enroll_all", "enroll_latinx", "enroll_aian", "enroll_asianam",
                        "enroll_nhpi", "enroll_black", "enroll_white", "enroll_twomore",
                        "enroll_el", "enroll_elserv", "enroll_sped"),
       variable.name = "Group",
       value.name = "Count") %>%
  ggplot(aes(x = Count, y = Group)) +
  geom_boxplot() + 
  theme_minimal()
```

Now creating a set of new variables. I am creating enrollment percents for each
race/ethnicity group as well as EL and SPED.

```{r }
enroll <- enroll %>%
  mutate(enroll_latinx_pct = (enroll_latinx/enroll_all)*100,
         enroll_aian_pct = (enroll_aian/enroll_all)*100,
         enroll_asianam_pct = (enroll_asianam/enroll_all)*100,
         enroll_nhpi_pct = (enroll_nhpi/enroll_all)*100,
         enroll_black_pct = (enroll_black/enroll_all)*100,
         enroll_white_pct = (enroll_white/enroll_all)*100,
         enroll_twomore_pct = (enroll_twomore/enroll_all)*100,
         enroll_el_pct = (enroll_el/enroll_all)*100,
         enroll_elserv_pct = (enroll_elserv/enroll_all)*100,
         enroll_sped_pct = (enroll_sped/enroll_all)*100)
```

Also checking to see distribution of all the variables by ploting them. I notice some 
are reporting percents higher than 100. For example, some schools, the percent of students
who are EL enrolled is greater than 100. This shouldn't be the case.

```{r }
enroll %>% 
  melt(id.vars = "SCH_NAME", 
       measure.vars = c( "enroll_latinx_pct", "enroll_aian_pct", "enroll_asianam_pct",
                        "enroll_nhpi_pct", "enroll_black_pct", "enroll_white_pct", "enroll_twomore_pct",
                        "enroll_el_pct", "enroll_elserv_pct", "enroll_sped_pct"),
       variable.name = "Group",
       value.name = "Count") %>%
  ggplot(aes(x = Count, y = Group)) +
  geom_boxplot() + 
  theme_minimal()

enroll %>%
    filter(enroll_el_pct > 100) %>%
    select(SCH_NAME,SCH_ENR_LEP_F,SCH_ENR_LEP_M, enroll_el, enroll_all, enroll_el_pct)
```

Recoding those schools that report percentages higher than 100. Doing this for EL% and SPED%.
For those cases, I just recoded back to 100 percent. It appears like it worked based on the visual.
Afterwards, I subset the file to only keep the school information, enrollment totals, and percent enrollment.

```{r }
enroll <- enroll %>%
  mutate(enroll_el_pct = ifelse(enroll_el_pct > 100,100,enroll_el_pct),
         enroll_elserv_pct = ifelse(enroll_elserv_pct > 100,100,enroll_elserv_pct),
         enroll_sped_pct = ifelse(enroll_sped_pct > 100,100,enroll_sped_pct)) 
```
  
Creating  District Level Independent variables (% EL, % SPED, % students of color)

```{r }
enroll <- enroll %>%
  group_by(LEAID) %>%
  mutate(dist_enrollment = sum(enroll_all),
         dist_percent_white = (sum(enroll_white)/dist_enrollment)*100,
         dist_percent_latinx = (sum(enroll_latinx)/dist_enrollment)*100,
         dist_percent_black = (sum(enroll_black)/dist_enrollment)*100,
         dist_percent_twomore = (sum(enroll_twomore)/dist_enrollment)*100,
         dist_percent_asianam= (sum(enroll_asianam)/dist_enrollment)*100,
         dist_percent_nhpi = (sum(enroll_nhpi)/dist_enrollment)*100,
         dist_percent_aian = (sum(enroll_aian)/dist_enrollment)*100,
         dist_percent_el = (sum(enroll_el)/dist_enrollment)*100,
         dist_percent_sped = (sum(enroll_sped)/dist_enrollment)*100
         )

enroll %>%
  melt(id.vars = "SCH_NAME", 
       measure.vars = c( "dist_percent_white", "dist_percent_latinx", "dist_percent_black",
                        "dist_percent_twomore", "dist_percent_asianam", "dist_percent_nhpi",
                        "dist_percent_aian", "dist_percent_el", "dist_percent_sped"),
       variable.name = "Group",
       value.name = "Percent") %>%
  ggplot(aes(x = Percent, y = Group)) +
  geom_boxplot() + 
  theme_minimal()
  


enroll %>%
  ggplot(aes(x = dist_enrollment, y = LEA_STATE_NAME)) +
  geom_density_ridges() + theme_minimal()
```

Replacing district rates with values greater than 100 to just 100

```{r }

enroll <- enroll %>%
  mutate(dist_percent_el = ifelse(dist_percent_el > 100,100,dist_percent_el),
         dist_percent_sped = ifelse(dist_percent_sped > 100,100,dist_percent_sped))

enroll %>%
  melt(id.vars = "SCH_NAME", 
       measure.vars = c( "dist_percent_white", "dist_percent_latinx", "dist_percent_black",
                        "dist_percent_twomore", "dist_percent_asianam", "dist_percent_nhpi",
                        "dist_percent_aian", "dist_percent_el", "dist_percent_sped"),
       variable.name = "Group",
       value.name = "Percent") %>%
  ggplot(aes(x = Percent, y = Group)) +
  geom_boxplot() + 
  theme_minimal()
``` 
  
Making the dataset smaller and just keeping variables that we need  
  
```{r }  
enroll <- enroll %>%  
select(c("LEA_STATE", "LEA_STATE_NAME", "LEAID", "LEA_NAME", "SCHID", "SCH_NAME", 
          "COMBOKEY", "JJ",  "enroll_all", "enroll_latinx", "enroll_aian", "enroll_asianam",
           "enroll_nhpi", "enroll_black", "enroll_white", "enroll_twomore",
           "enroll_el", "enroll_elserv", "enroll_sped","enroll_latinx_pct", 
          "enroll_aian_pct", "enroll_asianam_pct", "enroll_nhpi_pct", "enroll_black_pct", 
          "enroll_white_pct", "enroll_twomore_pct","enroll_el_pct", "enroll_elserv_pct", "enroll_sped_pct",
          "dist_percent_white", "dist_percent_latinx", "dist_percent_black",
          "dist_percent_twomore", "dist_percent_asianam", "dist_percent_nhpi",
          "dist_percent_aian", "dist_percent_el", "dist_percent_sped"))
```

*END OF ENROLLMENT DATA CLEANING*

### School Characteristic Cleaning

### Expulsions and Suspensions Cleaning

The first step of suspension and expulsion data cleaning is importing data

```{r import-data, include=FALSE}
susp <- read.csv(here("data", "Suspensions.csv")) %>% 
  clean_names() %>%  
  as_tibble()

```

The data we use contains negative values for missing data. Let's create a data set with no negative values across all variables. 

```{r no-na, include=FALSE}
susp1 <- susp
susp1[susp1 < 0] <- NA

susp1 <- susp1 %>% 
  drop_na()
```

However, if we only select row with complete information, we will miss too many observation. Instead, we decided to create clean the datasets based on the type of suspensions given in the following: 

*Preschool students suspension by race/ethnicity, gender, disability status*
* Only one out-of-school suspension
```{r include=FALSE}
preschool_one_susp <- susp %>% 
  select (1:8, 9:28, 49:50 )
preschool_one_susp[preschool_one_susp < 0] <- NA

preschool_one_susp <- preschool_one_susp %>% 
  drop_na()
preschool_one_susp
```
* more than one out-of-school suspensions
```{r include=FALSE}
preschool_more_susp <- 
  preschool_more_susp <- susp %>% 
  select (1:8, 29:50 )
preschool_more_susp[preschool_more_susp < 0] <- NA

preschool_more_susp <- preschool_more_susp %>% 
  drop_na()
preschool_more_susp
```

*Students who received one or more in-school suspension, by race/etchnicity, gender, disability status*

```{r include=FALSE}
one_in_susp <- susp %>% 
  select (1:8, 51:68, 105: 124 )
one_in_susp[one_in_susp < 0] <- NA

one_in_susp<- one_in_susp %>% 
  drop_na()
one_in_susp
```

*Students who received one out-of-school suspension, by race/etchnicity, gender, disability status*

```{r include=FALSE}
one_out_susp <- susp %>% 
  select (1:8, 69:86, 125: 144 )
one_out_susp[one_out_susp < 0] <- NA

one_out_susp<- one_out_susp %>% 
  drop_na()
one_out_susp
```

*Students who received more than one out-of-school suspension, by race/etchnicity, gender, disability status*
```{r include=FALSE}

more_out_susp <- susp %>% 
  select (1:8, 87:104, 145: 167 )
more_out_susp[more_out_susp < 0] <- NA

more_out_susp<- more_out_susp%>% 
  drop_na()
more_out_susp
```

*School days missed by gender, race, and disability status*

```{r include=FALSE}
days_missed <- susp %>% 
  select (1:8, 168:189 )
days_missed[days_missed < 0] <- NA

days_missed <- days_missed %>% 
  drop_na()
days_missed
```


*Then, we created subset and count the percentage for each category by race and gender*

* Preschool students one suspension by Race and Gender
  * Preschool Male Students 

```{r}
pre_one_susp_race_m <- preschool_one_susp %>% 
 summarize(bl_m = sum(sch_psdisc_singoos_bl_m)/sum(tot_psdisc_singoos_m) * 100, 
           hi_m = sum(sch_psdisc_singoos_hi_m)/sum(tot_psdisc_singoos_m)* 100,
           am_m = sum(sch_psdisc_singoos_am_m)/sum(tot_psdisc_singoos_m)* 100,
           as_m = sum(sch_psdisc_singoos_as_m)/sum(tot_psdisc_singoos_m)* 100,
           hp_m = sum(sch_psdisc_singoos_hp_m)/sum(tot_psdisc_singoos_m)* 100,
           wh_m = sum(sch_psdisc_singoos_wh_m)/sum(tot_psdisc_singoos_m)* 100,
           tr_m = sum(sch_psdisc_singoos_tr_m)/sum(tot_psdisc_singoos_m)* 100)  %>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "pre_one_susp_race_m")
pre_one_susp_race_m 

```
  
  * Preschool one suspension Female students

```{r}
pre_one_susp_race_f  <- preschool_one_susp %>% 
 summarize(bl_f = sum(sch_psdisc_singoos_bl_f)/sum(tot_psdisc_singoos_f) * 100, 
           hi_f = sum(sch_psdisc_singoos_hi_f)/sum(tot_psdisc_singoos_f)* 100,
           am_f = sum(sch_psdisc_singoos_am_f)/sum(tot_psdisc_singoos_f)* 100,
           as_f = sum(sch_psdisc_singoos_as_f)/sum(tot_psdisc_singoos_f)* 100,
           hp_f = sum(sch_psdisc_singoos_hp_f)/sum(tot_psdisc_singoos_f)* 100,
           wh_f = sum(sch_psdisc_singoos_wh_f)/sum(tot_psdisc_singoos_f)* 100,
           tr_f = sum(sch_psdisc_singoos_tr_f)/sum(tot_psdisc_singoos_f)* 100) %>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "pre_one_susp_race_f")
pre_one_susp_race_f

```

  * Preschool Students with more than one suspension by race and gender
    - Male Students

```{r}
pre_more_susp_race_m <- preschool_more_susp %>% 
  summarize(bl_m = sum(sch_psdisc_multoos_bl_m)/sum(tot_psdisc_multoos_m) * 100, 
           hi_m = sum(sch_psdisc_multoos_hi_m)/sum(tot_psdisc_multoos_m)* 100,
           am_m = sum(sch_psdisc_multoos_am_m)/sum(tot_psdisc_multoos_m)* 100,
           as_m = sum(sch_psdisc_multoos_as_m)/sum(tot_psdisc_multoos_m)* 100,
           hp_m = sum(sch_psdisc_multoos_hp_m)/sum(tot_psdisc_multoos_m)* 100,
           wh_m = sum(sch_psdisc_multoos_wh_m)/sum(tot_psdisc_multoos_m)* 100,
           tr_m = sum(sch_psdisc_multoos_tr_m)/sum(tot_psdisc_multoos_m)* 100) %>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "pre_more_susp_race_m")
pre_more_susp_race_m 

```
    - Female Students 
```{r}
pre_more_susp_race_f  <- preschool_more_susp%>% 
 summarize(bl_f = sum(sch_psdisc_multoos_bl_f)/sum(tot_psdisc_multoos_f) * 100, 
           hi_f = sum(sch_psdisc_multoos_hi_f)/sum(tot_psdisc_multoos_f)* 100,
           am_f = sum(sch_psdisc_multoos_am_f)/sum(tot_psdisc_multoos_f)* 100,
           as_f = sum(sch_psdisc_multoos_as_f)/sum(tot_psdisc_multoos_f)* 100,
           hp_f = sum(sch_psdisc_multoos_hp_f)/sum(tot_psdisc_multoos_f)* 100,
           wh_f = sum(sch_psdisc_multoos_wh_f)/sum(tot_psdisc_multoos_f)* 100,
           tr_f = sum(sch_psdisc_multoos_tr_f)/sum(tot_psdisc_multoos_f)* 100)  %>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "pre_more_susp_race_f")
pre_more_susp_race_f
```


  * Students without disability with one or more in-school-suspensions by race and gender

```{r include=FALSE}
in_susp_wodis_race_m <- one_in_susp %>% 
  summarize(bl_m = sum(sch_discwodis_iss_bl_m)/sum(tot_discwodis_iss_m) * 100, 
           hi_m = sum(sch_discwodis_iss_hi_m)/sum(tot_discwodis_iss_m)* 100,
           am_m = sum(sch_discwodis_iss_am_m)/sum(tot_discwodis_iss_m)* 100,
           as_m = sum(sch_discwodis_iss_as_m)/sum(tot_discwodis_iss_m)* 100,
           hp_m = sum(sch_discwodis_iss_hp_m)/sum(tot_discwodis_iss_m)* 100,
           wh_m = sum(sch_discwodis_iss_wh_m)/sum(tot_discwodis_iss_m)* 100,
           tr_m = sum(sch_discwodis_iss_tr_m)/sum(tot_discwodis_iss_m)* 100) %>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "in_susp_wodis_race_m")
in_susp_wodis_race_m 


in_susp_wodis_race_f <- one_in_susp %>%   
summarize(bl_f = sum(sch_discwodis_iss_bl_f)/sum(tot_discwodis_iss_f) * 100, 
           hi_f = sum(sch_discwodis_iss_hi_f)/sum(tot_discwodis_iss_f)* 100,
           am_f = sum(sch_discwodis_iss_am_f)/sum(tot_discwodis_iss_f)* 100,
           as_f = sum(sch_discwodis_iss_as_f)/sum(tot_discwodis_iss_f)* 100,
           hp_f = sum(sch_discwodis_iss_hp_f)/sum(tot_discwodis_iss_f)* 100,
           wh_f = sum(sch_discwodis_iss_wh_f)/sum(tot_discwodis_iss_f)* 100,
           tr_f = sum(sch_discwodis_iss_tr_f)/sum(tot_discwodis_iss_f)* 100) %>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "in_susp_wodis_race_f")
  
in_susp_wodis_race_f
```

  * Students with disability with one or more in-school-suspensions by race and gender
```{r}

in_susp_wdis_race_m <- one_in_susp %>%   
  summarize(bl_m = sum(sch_discwdis_iss_idea_bl_m)/sum(tot_discwdis_iss_idea_m) * 100, 
           hi_m = sum(sch_discwdis_iss_idea_hi_m)/sum(tot_discwdis_iss_idea_m)* 100,
           am_m = sum(sch_discwdis_iss_idea_am_m)/sum(tot_discwdis_iss_idea_m)* 100,
           as_m = sum(sch_discwdis_iss_idea_as_m)/sum(tot_discwdis_iss_idea_m)* 100,
           hp_m = sum(sch_discwdis_iss_idea_hp_m)/sum(tot_discwdis_iss_idea_m)* 100,
           wh_m = sum(sch_discwdis_iss_idea_wh_m)/sum(tot_discwdis_iss_idea_m)* 100,
           tr_m = sum(sch_discwdis_iss_idea_tr_m)/sum(tot_discwdis_iss_idea_m)* 100)%>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "in_susp_wdis_race_m")
in_susp_wdis_race_m

in_susp_wdis_race_f <- one_in_susp %>%   
  summarize(bl_f = sum(sch_discwdis_iss_idea_bl_f)/sum(tot_discwdis_iss_idea_f) * 100, 
           hi_f = sum(sch_discwdis_iss_idea_hi_f)/sum(tot_discwdis_iss_idea_f)* 100,
           am_f = sum(sch_discwdis_iss_idea_am_f)/sum(tot_discwdis_iss_idea_f)* 100,
           as_f = sum(sch_discwdis_iss_idea_as_f)/sum(tot_discwdis_iss_idea_f)* 100,
           hp_f = sum(sch_discwdis_iss_idea_hp_f)/sum(tot_discwdis_iss_idea_f)* 100,
           wh_f = sum(sch_discwdis_iss_idea_wh_f)/sum(tot_discwdis_iss_idea_f)* 100,
           tr_f = sum(sch_discwdis_iss_idea_tr_f)/sum(tot_discwdis_iss_idea_f)* 100) %>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "in_susp_wdis_race_f")
in_susp_wdis_race_f

```

  * Students without disability with only one out-of-school-suspensions by race and gender

```{r}

one_out_susp_wodis_race_m <- one_out_susp %>% 
  summarize(bl_m = sum(sch_discwodis_singoos_bl_m)/sum(tot_discwodis_singoos_m) * 100, 
           hi_m = sum(sch_discwodis_singoos_hi_m)/sum(tot_discwodis_singoos_m)* 100,
           am_m = sum(sch_discwodis_singoos_am_m)/sum(tot_discwodis_singoos_m)* 100,
           as_m = sum(sch_discwodis_singoos_as_m)/sum(tot_discwodis_singoos_m)* 100,
           hp_m = sum(sch_discwodis_singoos_hp_m)/sum(tot_discwodis_singoos_m)* 100,
           wh_m = sum(sch_discwodis_singoos_wh_m)/sum(tot_discwodis_singoos_m)* 100,
           tr_m = sum(sch_discwodis_singoos_tr_m)/sum(tot_discwodis_singoos_m)* 100) %>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "one_out_susp_wodis_race_m")
one_out_susp_wodis_race_m 

one_out_susp_wodis_race_f <- one_out_susp %>% 
  summarize(bl_f = sum(sch_discwodis_singoos_bl_f)/sum(tot_discwodis_singoos_f) * 100, 
           hi_f = sum(sch_discwodis_singoos_hi_f)/sum(tot_discwodis_singoos_f)* 100,
           am_f = sum(sch_discwodis_singoos_am_f)/sum(tot_discwodis_singoos_f)* 100,
           as_f = sum(sch_discwodis_singoos_as_f)/sum(tot_discwodis_singoos_f)* 100,
           hp_f = sum(sch_discwodis_singoos_hp_f)/sum(tot_discwodis_singoos_f)* 100,
           wh_f = sum(sch_discwodis_singoos_wh_f)/sum(tot_discwodis_singoos_f)* 100,
           tr_f = sum(sch_discwodis_singoos_tr_f)/sum(tot_discwodis_singoos_f)* 100) %>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "one_out_susp_wodis_race_f")
one_out_susp_wodis_race_f

```

  * Students with disability with one out-of-school-suspensions by race and gender

```{r}

one_out_susp_wdis_race_m <- one_out_susp %>% 
  summarize(bl_m = sum(sch_discwdis_singoos_idea_bl_m)/sum(tot_discwdis_singoos_idea_m) * 100, 
           hi_m = sum(sch_discwdis_singoos_idea_hi_m)/sum(tot_discwdis_singoos_idea_m)* 100,
           am_m = sum(sch_discwdis_singoos_idea_am_m)/sum(tot_discwdis_singoos_idea_m)* 100,
           as_m = sum(sch_discwdis_singoos_idea_as_m)/sum(tot_discwdis_singoos_idea_m)* 100,
           hp_m = sum(sch_discwdis_singoos_idea_hp_m)/sum(tot_discwdis_singoos_idea_m)* 100,
           wh_m = sum(sch_discwdis_singoos_idea_wh_m)/sum(tot_discwdis_singoos_idea_m)* 100,
           tr_m = sum(sch_discwdis_singoos_idea_tr_m)/sum(tot_discwdis_singoos_idea_m)* 100) %>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "one_out_susp_wdis_race_m")
one_out_susp_wdis_race_m 

one_out_susp_wdis_race_f <- one_out_susp %>% 
  summarize(bl_f = sum(sch_discwdis_singoos_idea_bl_f)/sum(tot_discwdis_singoos_idea_f) * 100, 
           hi_f = sum(sch_discwdis_singoos_idea_hi_f)/sum(tot_discwdis_singoos_idea_f)* 100,
           am_f = sum(sch_discwdis_singoos_idea_am_f)/sum(tot_discwdis_singoos_idea_f)* 100,
           as_f = sum(sch_discwdis_singoos_idea_as_f)/sum(tot_discwdis_singoos_idea_f)* 100,
           hp_f = sum(sch_discwdis_singoos_idea_hp_f)/sum(tot_discwdis_singoos_idea_f)* 100,
           wh_f = sum(sch_discwdis_singoos_idea_wh_f)/sum(tot_discwdis_singoos_idea_f)* 100,
           tr_f = sum(sch_discwdis_singoos_idea_tr_f)/sum(tot_discwdis_singoos_idea_f)* 100) %>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "one_out_susp_wdis_race_f")
one_out_susp_wdis_race_f
```

  * Student without disability with more than one out-of-school-suspensions by race and gender

```{r}
more_out_susp_wodis_race_m <- more_out_susp %>% 
  summarize(bl_m = sum(sch_discwodis_multoos_bl_m)/sum(tot_discwodis_multoos_m) * 100, 
           hi_m = sum(sch_discwodis_multoos_hi_m)/sum(tot_discwodis_multoos_m)* 100,
           am_m = sum(sch_discwodis_multoos_am_m)/sum(tot_discwodis_multoos_m)* 100,
           as_m = sum(sch_discwodis_multoos_as_m)/sum(tot_discwodis_multoos_m)* 100,
           hp_m = sum(sch_discwodis_multoos_hp_m)/sum(tot_discwodis_multoos_m)* 100,
           wh_m = sum(sch_discwodis_multoos_wh_m)/sum(tot_discwodis_multoos_m)* 100,
           tr_m = sum(sch_discwodis_multoos_tr_m)/sum(tot_discwodis_multoos_m)* 100) %>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "more_out_susp_wodis_race_m")
more_out_susp_wodis_race_m 

more_out_susp_wodis_race_f <- more_out_susp %>% 
  summarize(bl_f = sum(sch_discwodis_multoos_bl_f)/sum(tot_discwodis_multoos_f) * 100, 
           hi_f = sum(sch_discwodis_multoos_hi_f)/sum(tot_discwodis_multoos_f)* 100,
           am_f = sum(sch_discwodis_multoos_am_f)/sum(tot_discwodis_multoos_f)* 100,
           as_f = sum(sch_discwodis_multoos_as_f)/sum(tot_discwodis_multoos_f)* 100,
           hp_f = sum(sch_discwodis_multoos_hp_f)/sum(tot_discwodis_multoos_f)* 100,
           wh_f = sum(sch_discwodis_multoos_wh_f)/sum(tot_discwodis_multoos_f)* 100,
           tr_f = sum(sch_discwodis_multoos_tr_f)/sum(tot_discwodis_multoos_f)* 100)  %>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "more_out_susp_wodis_race_f")
more_out_susp_wodis_race_f

```

  * Student with disability with more than one out-of-school-suspensions by race and gender

```{r}
more_out_susp_wdis_race_m <- more_out_susp %>% 
  summarize(bl_m = sum(sch_discwdis_multoos_idea_bl_m)/sum(tot_discwdis_multoos_idea_m) * 100, 
           hi_m = sum(sch_discwdis_multoos_idea_hi_m)/sum(tot_discwdis_multoos_idea_m)* 100,
           am_m = sum(sch_discwdis_multoos_idea_am_m)/sum(tot_discwdis_multoos_idea_m)* 100,
           as_m = sum(sch_discwdis_multoos_idea_as_m)/sum(tot_discwdis_multoos_idea_m)* 100,
           hp_m = sum(sch_discwdis_multoos_idea_hp_m)/sum(tot_discwdis_multoos_idea_m)* 100,
           wh_m = sum(sch_discwdis_multoos_idea_wh_m)/sum(tot_discwdis_multoos_idea_m)* 100,
           tr_m = sum(sch_discwdis_multoos_idea_tr_m)/sum(tot_discwdis_multoos_idea_m)* 100)  %>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "more_out_susp_wdis_race_m")
more_out_susp_wdis_race_m 

more_out_susp_wdis_race_f <- more_out_susp %>% 
  summarize(bl_f = sum(sch_discwdis_multoos_idea_bl_f)/sum(tot_discwdis_multoos_idea_f) * 100, 
           hi_f = sum(sch_discwdis_multoos_idea_hi_f)/sum(tot_discwdis_multoos_idea_f)* 100,
           am_f = sum(sch_discwdis_multoos_idea_am_f)/sum(tot_discwdis_multoos_idea_f)* 100,
           as_f = sum(sch_discwdis_multoos_idea_as_f)/sum(tot_discwdis_multoos_idea_f)* 100,
           hp_f = sum(sch_discwdis_multoos_idea_hp_f)/sum(tot_discwdis_multoos_idea_f)* 100,
           wh_f = sum(sch_discwdis_multoos_idea_wh_f)/sum(tot_discwdis_multoos_idea_f)* 100,
           tr_f = sum(sch_discwdis_multoos_idea_tr_f)/sum(tot_discwdis_multoos_idea_f)* 100)%>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "more_out_susp_wdis_race_f")
more_out_susp_wdis_race_f

```


*The next step is combining all suspensions categories based on gender*


```{r}
all_race_m <- left_join(pre_one_susp_race_m, pre_more_susp_race_m) %>% 
  left_join(in_susp_wdis_race_m) %>% 
  left_join(one_out_susp_wodis_race_m) %>% 
  left_join(one_out_susp_wdis_race_m) %>% 
  left_join(more_out_susp_wodis_race_m) %>% 
  left_join(more_out_susp_wdis_race_m)
  
all_race_f <- left_join(pre_one_susp_race_f,pre_more_susp_race_f) %>% 
  left_join(in_susp_wdis_race_f) %>% 
  left_join(one_out_susp_wodis_race_f) %>% 
  left_join(one_out_susp_wdis_race_f) %>% 
  left_join(more_out_susp_wodis_race_f) %>% 
  left_join(more_out_susp_wdis_race_f)
```


```{r}
all_race_male <- cbind(all_race_m[1], stack(all_race_m[2:8])) %>% 
  select(race, ind, values) %>% 
  mutate_at(vars(values), funs(round(., 1)))

all_race_female <- cbind(all_race_f[1], stack(all_race_f[2:8])) %>% 
  select(race, ind, values) %>% 
  mutate_at(vars(values), funs(round(., 1)))

```

*At the end, we would like to visualize our date to show the suspensions data based on race and gender proportion 

  * Suspensions for male students by race

```{r Plot-race-suspensions, echo=FALSE, fig.height=10, fig.width=10}
all_race_male %>% 
  ggplot(aes(fill= race, x=ind, y=values))+
  geom_bar(position = "stack", stat= "identity", color = "black", width = 0.9)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  geom_text(aes(label = paste0(values, "%")),
            position = position_stack(vjust = 0.5), size = 2) + 
  labs(x = "Suspensions", 
       y = "Percentage",
       title = "Male Students Receiving Suspension, by Race, Gender, and Disability")

```

  * Suspension for female students by race
```{r echo=FALSE, fig.height=10, fig.width=10}
all_race_female %>% 
  ggplot(aes(fill= race, x=ind, y=values))+
  geom_bar(position = "stack", stat= "identity", color = "black", width = 0.9)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  geom_text(aes(label = paste0(values, "%")),
            position = position_stack(vjust = 0.5), size = 2)+ 
    labs(x = "Suspensions", 
       y = "Percentage",
       title = "Female Students Receiving Suspension, by Race, Gender, and Disability",
       color = "Race")
```
  


### Harassemnt/Bullying Cleaning

Let's read the data.
```{r read data}
hnb <- import(here("data","Harassment and Bullying.csv")) %>% 
    as_tibble()
hnb_col <- colnames(hnb)
```

**Quick summary:**

* There are `r ncol(hnb)` variables in this dataset.   
* First 8 are school characteristics  
* 9-13 are Harassment and Bullying allegations -- Allegations based on sex, ethnicity, disability status, sexual orientation and religion. Total varianles: `r length(grep("SCH_HBALLEGATIONS", hnb_col))`  
* 14 - 79 are #students reported as being bullied by different intent and demographic characteristics. Total variables: `r length(grep("SCH_HBREPORTED", hnb_col))`  
* 80 - 145 are #students discilined for bullying or harassing by different intent and demographic characteristics. Total variables: `r length(grep("SCH_DISCIPLINED", hnb_col))`  
* Totals are available (starts with TOT) for different intent (rex, race and disability status), reported/disciplined and gender (male, female) combo. Total variables for reported: `r length(grep("TOT_HBREPORTED", hnb_col))`, and Total variables for disciplined: `r length(grep("TOT_HBDISCIPLINED", hnb_col))`   

//_Note to self:_ `grep()` saves the indices of columns

First, let's change all negative numbers to NA. 

```{r hnb_pos}
#function to remove negative values
remove_neg <- function (x) ifelse(x < 0, NA, x)
hnb_pos <- hnb %>% 
    mutate(across(c(9:145), remove_neg))
```

Nice!

Let's make a shorter dataset to work with. I have allegations, reported and disciplined for the following intents: sex, race and disability. Let's just take these forward.

```{r hnb_sub}
#function to find relevant columns and sum them
cat_sum <- function(x, y) rowSums(select(x, starts_with(y)), na.rm = TRUE)

hnb_sub <- hnb_pos %>% 
    select("LEA_STATE","LEA_NAME","COMBOKEY", starts_with(c("SCH_HBALLEGATIONS","TOT_HBREPORTED","TOT_HBDISCIPLINED"))) %>% 
    mutate(TOT_HBREPORTED_SEX = cat_sum(.,"TOT_HBREPORTED_SEX"),
           TOT_HBREPORTED_RAC = cat_sum(.,"TOT_HBREPORTED_RAC"),
           TOT_HBREPORTED_DIS = cat_sum(.,"TOT_HBREPORTED_DIS"),
           TOT_HBDISCIPLINED_SEX = cat_sum(.,"TOT_HBDISCIPLINED_SEX"),
           TOT_HBDISCIPLINED_RAC = cat_sum(.,"TOT_HBDISCIPLINED_RAC"),
           TOT_HBDISCIPLINED_DIS = cat_sum(.,"TOT_HBDISCIPLINED_DIS"),
           TOT_HBALLEGATIONS = cat_sum(.,"SCH_HBALLEGATIONS"),
           TOT_HBREPORTED = cat_sum(.,"TOT_HBREPORTED"),
           TOT_HBDISCIPLINED = cat_sum(.,"TOT_HBDISCIPLINED")) %>% 
    filter(if_any(c(27:29),~ . > 0))
```

That looks like a neat data set. We have total `r ncol(hnb_sub)` variables - 3 are identifiers and rest are numeric. Also, we have filtered out rows where all numeric columns are 0.

Let's find some summary of cols.

```{r summary}
skim(hnb_sub)

```

This is super interesting! Some conclusions: 

* Allegations are highest, followed by disciplined and then reported. Probably, some teacher/adult saw the incident and disciplined the students involved, and hence things were not reported. Or, one student reported multiple people, hence the whole group was disciplined.    
* Allegation, reported and disciplined have highest raw count for the 'Disability' intent, followed by 'sex' and 'race'. However, the mean in all categories follow the order: 'sex', 'race' and 'disability'
* In reported, often female students report more frequencty for 'sex' intent, but male students report more often for 'race' and 'disability'
* In disciplined, for all intents, male students are more often disciplined than female students.

Let's do some plots now.

```{r scatter plot matrix allegations, out.width="100%"}

pairs.panels(hnb_sub[,4:8], 
             method = "pearson", # correlation method
             hist.col = "#00AFBB",
             density = TRUE,  # show density plots
             ellipses = TRUE # show correlation ellipses
             )

#pairs(hnb_sub[,4:8], pch = 19, lower.panel = NULL)
#plotmatrix(hnb_sub[,27:29], colour="gray20")
```

```{r total, out.width="100%"}
pairs.panels(hnb_sub[,27:29], 
             method = "pearson", # correlation method
             hist.col = "#00AFBB",
             density = TRUE,  # show density plots
             ellipses = TRUE # show correlation ellipses
             )
```
        
```{r group total, out.width="100%"}
pairs.panels(hnb_sub[,21:26], 
             method = "pearson", # correlation method
             hist.col = "#00AFBB",
             density = TRUE,  # show density plots
             ellipses = TRUE # show correlation ellipses
             )
```

Let's look at state-wide boxplot, but each point represents the district

```{r state and district, out.width="100%"}
hnb_sub2 <- hnb_sub %>% 
    group_by(LEA_NAME) %>% 
    mutate(district_all = mean(TOT_HBALLEGATIONS),
           district_rep = mean(TOT_HBREPORTED),
           district_dis = mean(TOT_HBDISCIPLINED))

hnb_sub2 %>% 
    group_by(LEA_STATE) %>% 
    ggplot() +
    geom_boxplot(aes(LEA_STATE, district_all))
```

Though exciting to do initial data analysis, let's make a data file we'll be using for the final analysis.

```{r columns from enroll and hnb}
hnb_trim <- hnb_pos %>% 
   mutate(TOT_HBDISCIPLINED = cat_sum(., "TOT_HBDISCIPLINED")) %>% 
   select("COMBOKEY", "TOT_HBDISCIPLINED")

enroll_trim <- enroll %>% 
      select(c(1:9))

dis_enrol <- left_join(enroll_trim,hnb_trim, by = "COMBOKEY") %>% 
    mutate(HNB_ENROL = ((TOT_HBDISCIPLINED*1000)/enroll_all)) %>% 
    filter(HNB_ENROL <= 1000)
```

```{r}
dis_enrol %>% 
    ggplot() +
        geom_histogram(aes(x = HNB_ENROL), bins = 200)+
        xlim(0,1000)+
        ylim(0, 300)
```

### Arrests and Referrals

# Methods

This analysis was conducted using publicly available data from the 2017-18 civil rights data collection. Each biennium, schools across the United States are required to respond and report key information about their school. This includes enrollment information, levels of school personnel, incidents of exclusionary discipline, harassment, and bullying.

## Sample and Exclusion Criteria

The sample in this study included K-12 schools across the United States. Overall, the 2017-18 civil rights data collection contains XXX schools who serve students in Grades K-12.  Schools categorized **{update when we figure out which schools are excluded** were excluded from the analysis.  The final sample included XX schools across the United States. Table 1 summarizes information on the study sample (see table x in the appendix). 

## Study Variables
The main predictor variable for research question one was the percent of teachers that are novice teachers at a school. This variable was calculated by dividing the number of novice teachers at a school by the total number of full time teachers. Across schools in our sample, the mean rate of novice teachers was X, and the numbers ranged from X to X. The main predictor of interest for research question two was the number of security personnel (sworn law enforcement officers and other security personnel) per 1000 students Across the school sample, the average rate of security personnel was X per 1000 students.

The analysis had three outcomes of interest that broadly examined school climate — one for research question one and two for RQ2. For research question 1, the main outcome of interest was the rate of students who received an exclusionary discipline (suspension and expulsion). More specifically, this variable was defined as the number of exclusionary cases per 1000 students at a school. For research question 2, the two variables of interest were rates of harassment/bullying and rates of referrals and arrests. Rate of harrassment and bulling was defined as the number of students per 1000 students who were disciplined for harassment/bullying. Rate of referral/arrests was defined as the number of students per 1000 students who received a referral or were arrested.

## Analytic Approach
Descriptive statistics and regression analysis were used to answer the two research questions. 

To answer the first research question, we used a 3-level hierarchical linear model with schools nested within districts and districts nested within states. The final model is represented by the following sets of equations. 
Y_jks= π_0ks+X_j+ 〖γ1〗_j Noviceteachers+ ε_jks
π_ks=β_00s+ r_0jk 
β_00s= γ_000+ μ_00k
Where the outcome (Y) of school (j) in district (k) in state (s) is predicted by a set of school level enrollment covariates (X_j) and a school level measure of counselor caseload. The γ1 coefficient represents the relationship between counselor caseload and study outcomes and addresses the first research question.

To answer the second research question...

## Second Research Question
```{r}
getwd()
```

```{r}
na_strings <- c(-3, -5, -6, -8, -9, -11)
```

```{r}
RA <- import(here("data", "Referrals and Arrests.csv")) %>%
as_tibble() %>%
 
set_na(na = c(-3, -5, -6, -8, -9, -11))
RA
```

```{r}
skim(RA)
```

Verify that COMBOKEY is the key for joining
```{r}
RA %>%
count(COMBOKEY)
```

Describe the RA data set
```{r}
RA %>%
  describeBy()
```

```{r}
str(RA)
```

```{r}
enroll <- import(here("data", "enroll.csv")) %>%
as_tibble() %>%
 
set_na(na = c(-3, -5, -6, -8, -9, -11))
```

Describe the enroll data set
```{r}
enroll %>%
  describeBy()
```

```{r}
str(enroll)
```

```{r}
ra_full <- full_join(enroll, RA)

ra_full
```

```{r}
export(ra_full, here("data", "ra_full.csv"))
```

```{r}
sch_su <- import(here("data", "sch_su.csv")) %>%
as_tibble() %>%
 
set_na(na = c(-3, -5, -6, -8, -9, -11))

sch_su
```

```{r}
ra_full_c <- ra_full %>%
  clean_names()
```

Complete data set
```{r}
ra_final <- full_join(ra_full_c, sch_su)

ra_final
```


```{r}
export(ra_final, here("data", "ra_final.csv"))
```

Dropping variables to show just the state and totals
```{r}
ra_lawst <- ra_final %>%
select(lea_state_name, starts_with("tot")) %>%
  set_na(na = c(-3, -5, -6, -8, -9, -11))

ra_lawst
```

Sum by state
```{r}
ra_sum <- ra_lawst %>%
  group_by(lea_state_name) %>%
  summarise_all(sum, na.rm = TRUE) %>%
  filter(lea_state_name != "NA")

ra_sum
```

```{r}
# export(ra_lawst, here("data", "ra_lawst.xlsx"))
```

pivot_longer to rearrange the data with less columns & more rows
```{r}
ra_sum2 <- ra_sum %>%
  pivot_longer(cols = starts_with("tot_"),
    names_to = "student_type",
    names_prefix = "tot_disc",
    values_to = "tot_st",
    values_drop_na = TRUE)

ra_sum2
```

IDEA (Individuals with Disabilities Education Act)
LEP stands for limited English Proficient
arr = Arrests, ref = referrals, wdis = with disability, & wodis = with out disability
```{r}
ra_sum3 <- ra_sum2 %>%
  mutate_at("student_type", str_replace, "_idea", "") %>%
  separate(student_type, c("status", "dis_act", "gender"), "_")

ra_sum3
```

```{r}
new_labels <- c("ref" = "Referrals", "arr" = "Arrests")
```

How to get it to show a break in the gender indicating disability status or a percentage of each gender that is disabled?
fct_rev added to flip state names alphabetical
labeller used to spell out facet_wrap labels
```{r}
ra_sum3 %>%
  ggplot(aes(x = fct_rev(lea_state_name), y = tot_st)) +
  geom_col(aes(fill = gender)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip() +
  facet_wrap(~dis_act, labeller = labeller(dis_act = new_labels)) +
  theme(panel.grid.major.y = element_line(colour = "black"), panel.background = element_blank(), strip.background =element_rect(fill="gold1")) +
  labs(x = "State",
       y = "Total",
       title = "Number of Student Arrests and Referrals by State",
       subtitle = "Visulalized by Gender") +
  scale_fill_discrete (name = "Gender", labels = c("Female", "Male"))
```

```{r}
ra_sum3 %>%
  ggplot(aes(x = fct_rev(lea_state_name), y = tot_st)) +
  geom_col(aes(fill = status)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip() +
  facet_wrap(~dis_act, labeller = labeller(dis_act = new_labels)) +
  theme(panel.grid.major.y = element_line(colour = "black"), panel.background = element_blank(), strip.background =element_rect(fill="darkolivegreen3")) +
  labs(x = "State",
       y = "Total",
       title = "Number of Student Arrests and Referrals by State",
       subtitle = "Visulalized by Disability Status") +
  scale_fill_manual (name = "Disability Status", values = c("darksalmon", "tomato4"), labels = c("Yes", "No"))
```

Multiple Regression
```{r}
ra_final %>%
  colnames ()
```

Changed "Not Reported" data to NA; checked that code worked by searching for the phrase in the view data pane
```{r}
ra_reg <- ra_final %>%
select(lea_state, lea_state_name, leaid, lea_name, schid, sch_name, combokey, jj, enroll_all, starts_with("tot"), sch_ftesecurity_leo, sch_ftesecurity_gua) %>%
  set_na(na = c("Not Reported"))

ra_reg
```

Still working on this code & will update soon...
```{r}
ra_tidy <- ra_lawst %>%
  group_by(lea_state_name) %>%
  summarise_all(sum, na.rm = TRUE) %>%
  filter(lea_state_name != "NA")

pivot_longer(cols = starts_with("tot_"),
    names_to = "student_type",
    names_prefix = "tot_disc",
    values_to = "tot_st",
    values_drop_na = TRUE)

mutate_at("student_type", str_replace, "_idea", "") %>%
  separate(student_type, c("status", "dis_act", "gender"), "_")

ra_sum2
```


```{r}
ra_tidy %>%
  describeBy()
```



# Results

# Discussion

# References


