---
title: "School Personnel and School Climate"
author: "TEAM QRME"
date: "11/10/2021"
output: 
    html_document:
        toc: true
        toc_float: true
        toc_depth: 3
        highlight: pygments
        code_folding: hide
---
<!-- The table of contents was a really nice feature to have while reviewing your knitted doc -->
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      error = FALSE,
                      fig.width = 9, 
                      fig.height = 9)

# Add your packages that you need here. This will load the libraries
#removed purr - part of tidyverse
#let's only include libraries we are using so that others don't have to install the irrelevant ones 
#if (!require("pacman")) install.packages("pacman") 
#pacman::p_load(tidyverse, rio, here, ggridges, readr, ggthemes, sandwich, pracma, lme4,equatiomatic, performance, jtools, sundry,naniar,stargazer,vtable, reshape2, skimr, rddtools,tidylog,janitor) 
pacman::p_load(tidyverse, rio, here, ggridges, ggthemes, skimr, tidylog, janitor, reshape2, psych,jtools, lme4, sjPlot, sjmisc) 

#library(tidylog) #uncheck when writing code for log

# library(naniar)
# library(readr)
# library(magrittr)
# library(sjmisc)
# library(tinytex)
# library(crayon)
```

# Abstract

# Introduction 

This research project will be conducted using High School and Middle School level data from the [**Civil Rights Data Collection (CRDC)**](https://ocrdata.ed.gov/), 2017-2018 data set. The CRDC contains multiple data sets that cover a range of topics. From the overall data set, we are focusing on frequency data reported in the following areas: 
<!-- What does LEO stand for? -->
1. School Support (count of enrolled novice teachers, sworn LEO)
2. Referrals & Arrests (count of referrals and arrests of students by subgroup)
3. Suspensions and Expulsions (count of suspensions and expulsions of students by subgroup)
4. Enrollment (count of enrolled students by subgroup)
5. School characteristics (magnet, alternate, charter, special ed)

## Research Questions  

**1. Relationship of Concentration of novice teachers and rate of exclusionary discipline (i.e., suspensions, expulsions) in K-12 school students** 

* Vary by student subgroups? (i.e. race, disability)
* Vary district?
* Vary by state?


**2. Relationship of security guard density and referrals + arrests in K-12 school students** 

* Should we see if there is any correlation between corporal punishment and security guard presence?
* Might vary by student characteristic (e.g., students with disabilities, gender, grade level, or race)
* Number of transfers out of schools with guards might be at an increased level

## Cleaning different files

Since we're using multiple files, we created a master file to have all the necessary variables in one data set, called data_joined. We exported this file to reduce the run-time of the code. Below is our data cleaning process, but `eval = FALSE` as we don't want to run this code each time.

### Enrollment Data Set

Read file

```{r load enroll file, eval = FALSE}
enroll <- import(here("data", "Enrollment.csv")) %>%
    as_tibble() %>%
    clean_names()

```

Change negative to NA

```{r enroll remove neg, eval = FALSE}
#Function to remove negative numbers from data

remove_neg <- function (x) ifelse(x < 0, NA, x)

enroll <- enroll %>% 
    mutate(across(c(9:123), remove_neg)) %>% 
    select(-c(9:31))  #removing pre-K enrollment data
```

Now, I'm using PivotLonger and PivotWider to extract all information from columns.

```{r enroll tidy_1, eval = FALSE}
#Extracting information for columns starting with 'tot_'

enroll_total <- enroll %>% 
        select(c(1:8), matches('tot'))%>% 
        pivot_longer(
            cols = -c(1:8), 
            names_to = c("enroll_type", "gender"),
            names_sep = "_",
            names_prefix = "tot_",
            values_to = "students" 
        ) %>%
    group_by(combokey, enroll_type) %>% 
        summarize(
            total = sum(students, na.rm = TRUE)
        ) %>% 
    pivot_wider(
        names_from = 2,
        values_from = total,
        names_sep = "_",
        names_prefix = "tot_"
    ) %>% 
  as_tibble()

```


```{r enroll tidy_2, eval = FALSE}
#Extracting information for columns starting with 'sch_'

enroll_tidy <- enroll %>% 
        select(-matches('tot'))%>% 
        pivot_longer(
            cols = -c(1:8), 
            names_to = c("enroll_type", "classification","gender"),
            names_sep = "_",
            names_prefix = "sch_",
            values_to = "students" 
        ) %>%         
        group_by(combokey, enroll_type, classification) %>% 
        summarize(
            total = sum(students, na.rm = TRUE)
        ) %>% 
      pivot_wider(
        names_from = c(2:3),
        values_from = total,
        names_sep = "_",
        names_prefix = "sch_"
    ) %>% 
    as_tibble()

```

```{r enroll joining, eval = FALSE}
#Joining all files to have information for analysis

enroll_final <- enroll_tidy %>% 
    right_join(.,enroll[,1:8],by = 'combokey') %>% 
    right_join(., enroll_total,by = 'combokey') %>%
    select(c(lea_state:jj), combokey, 'tot_enr',contains("_enr_"), everything()) %>% 
    as_tibble()
```


```{r enrol pct, eval = FALSE}
# Expressing enrollment across categories as percentage of total enrollment

enroll_final <- enroll_final %>%
  mutate(across(-c(1:9), ~ . / !! enroll_final$tot_enr * 100)) 
```

Note: For 11 schools, total enrollment is 0. Therefore, the percentages come as NA for them. Probably because these schools only have preK enrollment. 

```{r enroll errors, eval = FALSE}
enroll_100 <- enroll_final %>% 
  select(c(1:19)) %>% 
  filter_at(vars(c(10:19)),any_vars(.>100))
```

Note: For very few schools, the pct over one sub-group is greater than 100 - this mostly happens in the `idea` enrollment. 

### Suspension Data set

```{r load suspension data and susset, eval = FALSE}
susp <- import(here("data", "Suspensions.csv")) %>%
    as_tibble() %>%
    clean_names() %>% 
    mutate(across(c(9:189), remove_neg))

#preK suspension data
susp_ps <- susp %>% 
  select(c(1:50)) 

#K12 suspension
susp_k12 <- susp %>% 
  select(c(1:8,51:167))

```

Tidy data for regression

```{r susp_sum, eval = FALSE}

#K-12 summary data
susp_sum <- susp_k12 %>% 
  select(combokey, matches('tot|_504_')) %>% 
  mutate(
    tot_susp = rowSums(across(where(is.numeric)), na.rm = TRUE)
  ) %>% 
  select(combokey, tot_susp)
  

```

### School Support 

Import and Tidying

```{r load_support_data, eval = FALSE}
support<- read_csv(here("data", "School Support.csv")) %>%
  as_tibble() %>%
  clean_names() %>% 
  mutate(across(c(9:22),remove_neg)) %>% 
  mutate(sum_new_teachers = (sch_fteteach_sy + sch_fteteach_fy),
    pct_new_teachers = sum_new_teachers*100/sch_fteteach_tot, #should be sch_fteteach_tot instead of sch_teachers_curr_total
    tot_law = rowSums(select(., contains('_ftesecurity_')), na.rm = TRUE)
        )
support_sum <- support %>% 
  select(c(combokey, pct_new_teachers, sch_fteteach_tot, tot_law))

# Tidy data for descriptive analysis

support_tidy <- support %>% 
  pivot_longer(cols = -c(1:8,23,24),
               names_to = c("untidy1","detail1","detail2"),
               values_to = "count_teachers",
               names_prefix = "sch_",
               names_sep = "_"
  ) %>% 
  mutate(
    fte = case_when(
      str_detect(untidy1,"fte") ~ "Yes",
      TRUE ~ "No"
    ),
    untidy1 = str_remove(untidy1,"fte"),
    tot = case_when(
      str_detect(detail1,"tot") ~ "Yes",
      str_detect(detail2,"tot") ~ "Yes",
      TRUE ~ "No"
    ),
    detail1 = str_remove(detail1,"tot"),
    employee_category = untidy1,
  ) %>% 
  filter(tot == "Yes" & fte == "Yes") %>% 
  select(-c(detail2,detail1,untidy1,tot,fte,employee_category)) %>% 
  select(-c(1:6,8))


          
```


### School Characteristics Tidying

```{r load and tidy characteristics, eval = FALSE}

sch_characteristics_raw <- import(here("data","School Characteristics.csv")) %>% 
  as_tibble() %>% 
  clean_names()

#function to change Yes to 1, and No to 0
helperFunction <- function(x){
    ifelse(x=="Yes", 1,0)
}

sch_characteristics <- sch_characteristics_raw %>%
  mutate(across(c(9:32),remove_neg)) %>% 
  select(combokey, c(27:30)) %>% 
  mutate(across(c(2:5),helperFunction))

 #Just pivoting longer and wider w/o any manipulation
# characteristics_tidy <- sch_characteristics %>% 
#   pivot_longer(cols = (8:12),
#                names_to = "type",
#                values_to = "status",
#                names_prefix = "sch_status_",
#                names_transform = list(
#     gender = ~ readr::parse_factor(.x, levels = c("f", "m")),
#     ) %>% 
#   pivot_wider(names_from = type,
#               values_from = status) %>% 
#   select(-(1:6))

```

### Expulsion Data Set

```{r load expulsion data and subset, eval = FALSE}
expl <- import(here("data", "Expulsions.csv")) %>%
    as_tibble() %>%
    clean_names() %>% 
    mutate(across(c(9:142), remove_neg))

#preK expulsion data
expl_ps <- expl %>% 
  select(c(1:8), matches('psdisc')) 

#K12 data expulsion data
expl_k12 <- expl %>% 
  select(c(1:142), -matches('psdisc'))

```

Tidy data for regression

```{r expl_sum, eval = FALSE}

#K-12 summary data
expl_sum <- expl_k12  %>% 
  select(combokey, matches('tot|_504_')) %>% 
  mutate(
    tot_expl = rowSums(across(where(is.numeric)), na.rm = TRUE)
  ) %>% 
  select(combokey, tot_expl)
  
```

### Referals and Arrest Data Set

```{r ra_sum, eval = FALSE}
ra_sum <- import(here("data", "Referrals and Arrests.csv")) %>%
    as_tibble() %>%
    clean_names() %>% 
    mutate(across(c(9:84), remove_neg)) %>% 
    select(combokey, matches('tot|_504_')) %>% 
    mutate(
    tot_ref = rowSums(select(., contains('_ref_')), na.rm = TRUE),
    tot_arr = rowSums(select(., contains('_arr_')), na.rm = TRUE)
    ) %>% 
  select(combokey, tot_ref, tot_arr)
```

### Joined Data

```{r joined, eval = FALSE}
# Function to calculate rates per 1000 student
rate <- function(x) (x*1000 / enroll_final$tot_enr)

data_join <- enroll_final %>% 
  left_join(sch_characteristics, by = 'combokey') %>% 
  select(c(1:8, 55:58, 9, 11:15, 18:19, 17, 16, 10)) %>% 
  left_join(susp_sum, by = 'combokey') %>% 
  left_join(expl_sum, by = 'combokey') %>% 
  left_join(ra_sum, by = 'combokey') %>% 
  left_join(support_sum, by = 'combokey') %>%
  mutate(
  susp_std = rate(tot_susp),
  expl_std = rate(tot_expl),
  ref_std = rate(tot_ref),
  arr_std = rate(tot_arr),
  law_std = rate(tot_law)
  )



```


```{r export, eval = FALSE}
#export(data_join, here("data","data_join.csv"))
```



## Descriptive Findings {.tabset}
<!-- I like the use of tabs to organize your figures -->
From the different data sets, we'll be creating some figures.


### Expulsions and Suspensions Cleaning

We'll be creating longer version for this data-set.


```{r load suspension and expulsion}
#Function to remove negative numbers from data

remove_neg <- function (x) ifelse(x < 0, NA, x)

susp <- import(here("data", "Suspensions.csv")) %>%
    as_tibble() %>%
    clean_names() %>% 
    mutate(across(c(9:189), remove_neg))

#preK suspension data
susp_ps <- susp %>% 
  select(c(1:50)) 

#K12 suspension
susp_k12 <- susp %>% 
  select(c(1:8,51:167))

expl <- import(here("data", "Expulsions.csv")) %>%
    as_tibble() %>%
    clean_names() %>% 
    mutate(across(c(9:142), remove_neg))

#preK expulsion data
expl_ps <- expl %>% 
  select(c(1:8), matches('psdisc')) 

#K12 data expulsion data
expl_k12 <- expl %>% 
  select(c(1:142), -matches('psdisc'))

```


```{r tidy data}

susp_k12_504 <- susp_k12 %>% 
        select(combokey, matches('_504_')) %>% 
        rename_with( ~ (gsub("_504_", "_all_", .x, fixed = TRUE))) %>% 
        rename_with( ~ (gsub("discwdis", "504", .x, fixed = TRUE)))

susp_k12_tidy <- susp_k12 %>% 
        select(-matches('tot|_504|oosinstances')) %>% 
        rename_with( ~ (gsub("_idea_", "_", .x, fixed = TRUE))) %>% 
        rename_with( ~ (gsub("discwdis", "idea", .x, fixed = TRUE))) %>% 
        left_join(susp_k12_504, by = "combokey") %>% 
        rename_with( ~ (gsub("discwodis", "no", .x, fixed = TRUE))) %>% 
        pivot_longer(
            cols = -c(1:8), 
            names_to = c("disability", "type","ethnicity/lep", "gender"),
            names_sep = "_",
            names_prefix = "sch_",
            values_to = "students",
        )

susp_ps_tidy <- susp_ps %>% 
        select(-matches('tot|oosinstances'))%>% 
        pivot_longer(
            cols = -c(1:8), 
            names_to = c("type", "ethnicity/lep/idea","gender"),
            names_sep = "_",
            names_prefix = "sch_psdisc_",
            values_to = "students" 
        )

expl_k12_504 <- expl_k12 %>% 
        select(combokey, matches('_504_')) %>% 
        rename_with( ~ (gsub("_504_", "_all_", .x, fixed = TRUE))) %>% 
        rename_with( ~ (gsub("discwdis", "504", .x, fixed = TRUE)))

expl_k12_tidy <- expl_k12 %>% 
        select(-matches('tot')) %>% 
        rename_with( ~ (gsub("_idea_", "_", .x, fixed = TRUE))) %>% 
        rename_with( ~ (gsub("discwdis", "idea", .x, fixed = TRUE))) %>% 
        left_join(expl_k12_504, by = "combokey") %>% 
        rename_with( ~ (gsub("discwodis", "no", .x, fixed = TRUE))) %>% 
        pivot_longer(
            cols = -c(1:8), 
            names_to = c("disability", "type","ethnicity/lep", "gender"),
            names_sep = "_",
            names_prefix = "sch_",
            values_to = "students",
        )

expl_ps_tidy <- expl_ps %>% 
        select(-matches('tot'))%>% 
        pivot_longer(
            cols = -c(1:8), 
            names_to = c("type", "ethnicity/lep/idea","gender"),
            names_sep = "_",
            names_prefix = "sch_psdisc_",
            values_to = "students" 
        )

```


**Note: The below code was written before we learnt pivot_longer. We plan to recreate the figure using the tidy data we created above.**

The data we use contains negative values for missing data. Let's create a data set with no negative values across all variables. 

```{r no-na, include=FALSE, eval = FALSE}
susp1 <- susp
susp1[susp1 < 0] <- NA

susp1 <- susp1 %>% 
  drop_na()
```

However, if we only select row with complete information, we will miss too many observation. Instead, we decided to create clean the datasets based on the type of suspensions given in the following: 

*Preschool students suspension by race/ethnicity, gender, disability status*
* Only one out-of-school suspension
```{r include=FALSE, eval = FALSE}
preschool_one_susp <- susp %>% 
  select (1:8, 9:28, 49:50 )
preschool_one_susp[preschool_one_susp < 0] <- NA

preschool_one_susp <- preschool_one_susp %>% 
  drop_na()
preschool_one_susp
```
* more than one out-of-school suspensions
```{r include=FALSE, eval = FALSE}
preschool_more_susp <- 
  preschool_more_susp <- susp %>% 
  select (1:8, 29:50 )
preschool_more_susp[preschool_more_susp < 0] <- NA

preschool_more_susp <- preschool_more_susp %>% 
  drop_na()
preschool_more_susp
```

*Students who received one or more in-school suspension, by race/etchnicity, gender, disability status*

```{r include=FALSE, eval = FALSE}
one_in_susp <- susp %>% 
  select (1:8, 51:68, 105: 124 )
one_in_susp[one_in_susp < 0] <- NA

one_in_susp<- one_in_susp %>% 
  drop_na()
one_in_susp
```

*Students who received one out-of-school suspension, by race/etchnicity, gender, disability status*

```{r include=FALSE, eval = FALSE}
one_out_susp <- susp %>% 
  select (1:8, 69:86, 125: 144 )
one_out_susp[one_out_susp < 0] <- NA

one_out_susp<- one_out_susp %>% 
  drop_na()
one_out_susp
```

*Students who received more than one out-of-school suspension, by race/etchnicity, gender, disability status*
```{r include=FALSE, eval = FALSE}

more_out_susp <- susp %>% 
  select (1:8, 87:104, 145: 167 )
more_out_susp[more_out_susp < 0] <- NA

more_out_susp<- more_out_susp%>% 
  drop_na()
more_out_susp
```

*School days missed by gender, race, and disability status*

```{r include=FALSE, eval = FALSE}
days_missed <- susp %>% 
  select (1:8, 168:189 )
days_missed[days_missed < 0] <- NA

days_missed <- days_missed %>% 
  drop_na()
days_missed
```


*Then, we created subset and count the percentage for each category by race and gender*

* Preschool students one suspension by Race and Gender
  * Preschool Male Students 

```{r, eval = FALSE}
pre_one_susp_race_m <- preschool_one_susp %>% 
 summarize(bl_m = sum(sch_psdisc_singoos_bl_m)/sum(tot_psdisc_singoos_m) * 100, 
           hi_m = sum(sch_psdisc_singoos_hi_m)/sum(tot_psdisc_singoos_m)* 100,
           am_m = sum(sch_psdisc_singoos_am_m)/sum(tot_psdisc_singoos_m)* 100,
           as_m = sum(sch_psdisc_singoos_as_m)/sum(tot_psdisc_singoos_m)* 100,
           hp_m = sum(sch_psdisc_singoos_hp_m)/sum(tot_psdisc_singoos_m)* 100,
           wh_m = sum(sch_psdisc_singoos_wh_m)/sum(tot_psdisc_singoos_m)* 100,
           tr_m = sum(sch_psdisc_singoos_tr_m)/sum(tot_psdisc_singoos_m)* 100)  %>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "pre_one_susp_race_m")
pre_one_susp_race_m 

```
  
  * Preschool one suspension Female students

```{r, eval = FALSE}
pre_one_susp_race_f  <- preschool_one_susp %>% 
 summarize(bl_f = sum(sch_psdisc_singoos_bl_f)/sum(tot_psdisc_singoos_f) * 100, 
           hi_f = sum(sch_psdisc_singoos_hi_f)/sum(tot_psdisc_singoos_f)* 100,
           am_f = sum(sch_psdisc_singoos_am_f)/sum(tot_psdisc_singoos_f)* 100,
           as_f = sum(sch_psdisc_singoos_as_f)/sum(tot_psdisc_singoos_f)* 100,
           hp_f = sum(sch_psdisc_singoos_hp_f)/sum(tot_psdisc_singoos_f)* 100,
           wh_f = sum(sch_psdisc_singoos_wh_f)/sum(tot_psdisc_singoos_f)* 100,
           tr_f = sum(sch_psdisc_singoos_tr_f)/sum(tot_psdisc_singoos_f)* 100) %>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "pre_one_susp_race_f")
pre_one_susp_race_f

```

  * Preschool Students with more than one suspension by race and gender
    - Male Students

```{r, eval = FALSE}
pre_more_susp_race_m <- preschool_more_susp %>% 
  summarize(bl_m = sum(sch_psdisc_multoos_bl_m)/sum(tot_psdisc_multoos_m) * 100, 
           hi_m = sum(sch_psdisc_multoos_hi_m)/sum(tot_psdisc_multoos_m)* 100,
           am_m = sum(sch_psdisc_multoos_am_m)/sum(tot_psdisc_multoos_m)* 100,
           as_m = sum(sch_psdisc_multoos_as_m)/sum(tot_psdisc_multoos_m)* 100,
           hp_m = sum(sch_psdisc_multoos_hp_m)/sum(tot_psdisc_multoos_m)* 100,
           wh_m = sum(sch_psdisc_multoos_wh_m)/sum(tot_psdisc_multoos_m)* 100,
           tr_m = sum(sch_psdisc_multoos_tr_m)/sum(tot_psdisc_multoos_m)* 100) %>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "pre_more_susp_race_m")
pre_more_susp_race_m 

```
    - Female Students 
```{r, eval = FALSE}
pre_more_susp_race_f  <- preschool_more_susp%>% 
 summarize(bl_f = sum(sch_psdisc_multoos_bl_f)/sum(tot_psdisc_multoos_f) * 100, 
           hi_f = sum(sch_psdisc_multoos_hi_f)/sum(tot_psdisc_multoos_f)* 100,
           am_f = sum(sch_psdisc_multoos_am_f)/sum(tot_psdisc_multoos_f)* 100,
           as_f = sum(sch_psdisc_multoos_as_f)/sum(tot_psdisc_multoos_f)* 100,
           hp_f = sum(sch_psdisc_multoos_hp_f)/sum(tot_psdisc_multoos_f)* 100,
           wh_f = sum(sch_psdisc_multoos_wh_f)/sum(tot_psdisc_multoos_f)* 100,
           tr_f = sum(sch_psdisc_multoos_tr_f)/sum(tot_psdisc_multoos_f)* 100)  %>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "pre_more_susp_race_f")
pre_more_susp_race_f
```


  * Students without disability with one or more in-school-suspensions by race and gender

```{r include=FALSE, eval = FALSE}
in_susp_wodis_race_m <- one_in_susp %>% 
  summarize(bl_m = sum(sch_discwodis_iss_bl_m)/sum(tot_discwodis_iss_m) * 100, 
           hi_m = sum(sch_discwodis_iss_hi_m)/sum(tot_discwodis_iss_m)* 100,
           am_m = sum(sch_discwodis_iss_am_m)/sum(tot_discwodis_iss_m)* 100,
           as_m = sum(sch_discwodis_iss_as_m)/sum(tot_discwodis_iss_m)* 100,
           hp_m = sum(sch_discwodis_iss_hp_m)/sum(tot_discwodis_iss_m)* 100,
           wh_m = sum(sch_discwodis_iss_wh_m)/sum(tot_discwodis_iss_m)* 100,
           tr_m = sum(sch_discwodis_iss_tr_m)/sum(tot_discwodis_iss_m)* 100) %>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "in_susp_wodis_race_m")
in_susp_wodis_race_m 


in_susp_wodis_race_f <- one_in_susp %>%   
summarize(bl_f = sum(sch_discwodis_iss_bl_f)/sum(tot_discwodis_iss_f) * 100, 
           hi_f = sum(sch_discwodis_iss_hi_f)/sum(tot_discwodis_iss_f)* 100,
           am_f = sum(sch_discwodis_iss_am_f)/sum(tot_discwodis_iss_f)* 100,
           as_f = sum(sch_discwodis_iss_as_f)/sum(tot_discwodis_iss_f)* 100,
           hp_f = sum(sch_discwodis_iss_hp_f)/sum(tot_discwodis_iss_f)* 100,
           wh_f = sum(sch_discwodis_iss_wh_f)/sum(tot_discwodis_iss_f)* 100,
           tr_f = sum(sch_discwodis_iss_tr_f)/sum(tot_discwodis_iss_f)* 100) %>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "in_susp_wodis_race_f")
  
in_susp_wodis_race_f
```

  * Students with disability with one or more in-school-suspensions by race and gender
```{r, eval = FALSE}

in_susp_wdis_race_m <- one_in_susp %>%   
  summarize(bl_m = sum(sch_discwdis_iss_idea_bl_m)/sum(tot_discwdis_iss_idea_m) * 100, 
           hi_m = sum(sch_discwdis_iss_idea_hi_m)/sum(tot_discwdis_iss_idea_m)* 100,
           am_m = sum(sch_discwdis_iss_idea_am_m)/sum(tot_discwdis_iss_idea_m)* 100,
           as_m = sum(sch_discwdis_iss_idea_as_m)/sum(tot_discwdis_iss_idea_m)* 100,
           hp_m = sum(sch_discwdis_iss_idea_hp_m)/sum(tot_discwdis_iss_idea_m)* 100,
           wh_m = sum(sch_discwdis_iss_idea_wh_m)/sum(tot_discwdis_iss_idea_m)* 100,
           tr_m = sum(sch_discwdis_iss_idea_tr_m)/sum(tot_discwdis_iss_idea_m)* 100)%>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "in_susp_wdis_race_m")
in_susp_wdis_race_m

in_susp_wdis_race_f <- one_in_susp %>%   
  summarize(bl_f = sum(sch_discwdis_iss_idea_bl_f)/sum(tot_discwdis_iss_idea_f) * 100, 
           hi_f = sum(sch_discwdis_iss_idea_hi_f)/sum(tot_discwdis_iss_idea_f)* 100,
           am_f = sum(sch_discwdis_iss_idea_am_f)/sum(tot_discwdis_iss_idea_f)* 100,
           as_f = sum(sch_discwdis_iss_idea_as_f)/sum(tot_discwdis_iss_idea_f)* 100,
           hp_f = sum(sch_discwdis_iss_idea_hp_f)/sum(tot_discwdis_iss_idea_f)* 100,
           wh_f = sum(sch_discwdis_iss_idea_wh_f)/sum(tot_discwdis_iss_idea_f)* 100,
           tr_f = sum(sch_discwdis_iss_idea_tr_f)/sum(tot_discwdis_iss_idea_f)* 100) %>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "in_susp_wdis_race_f")
in_susp_wdis_race_f

```

  * Students without disability with only one out-of-school-suspensions by race and gender

```{r, eval = FALSE}

one_out_susp_wodis_race_m <- one_out_susp %>% 
  summarize(bl_m = sum(sch_discwodis_singoos_bl_m)/sum(tot_discwodis_singoos_m) * 100, 
           hi_m = sum(sch_discwodis_singoos_hi_m)/sum(tot_discwodis_singoos_m)* 100,
           am_m = sum(sch_discwodis_singoos_am_m)/sum(tot_discwodis_singoos_m)* 100,
           as_m = sum(sch_discwodis_singoos_as_m)/sum(tot_discwodis_singoos_m)* 100,
           hp_m = sum(sch_discwodis_singoos_hp_m)/sum(tot_discwodis_singoos_m)* 100,
           wh_m = sum(sch_discwodis_singoos_wh_m)/sum(tot_discwodis_singoos_m)* 100,
           tr_m = sum(sch_discwodis_singoos_tr_m)/sum(tot_discwodis_singoos_m)* 100) %>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "one_out_susp_wodis_race_m")
one_out_susp_wodis_race_m 

one_out_susp_wodis_race_f <- one_out_susp %>% 
  summarize(bl_f = sum(sch_discwodis_singoos_bl_f)/sum(tot_discwodis_singoos_f) * 100, 
           hi_f = sum(sch_discwodis_singoos_hi_f)/sum(tot_discwodis_singoos_f)* 100,
           am_f = sum(sch_discwodis_singoos_am_f)/sum(tot_discwodis_singoos_f)* 100,
           as_f = sum(sch_discwodis_singoos_as_f)/sum(tot_discwodis_singoos_f)* 100,
           hp_f = sum(sch_discwodis_singoos_hp_f)/sum(tot_discwodis_singoos_f)* 100,
           wh_f = sum(sch_discwodis_singoos_wh_f)/sum(tot_discwodis_singoos_f)* 100,
           tr_f = sum(sch_discwodis_singoos_tr_f)/sum(tot_discwodis_singoos_f)* 100) %>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "one_out_susp_wodis_race_f")
one_out_susp_wodis_race_f

```

  * Students with disability with one out-of-school-suspensions by race and gender

```{r, eval = FALSE}

one_out_susp_wdis_race_m <- one_out_susp %>% 
  summarize(bl_m = sum(sch_discwdis_singoos_idea_bl_m)/sum(tot_discwdis_singoos_idea_m) * 100, 
           hi_m = sum(sch_discwdis_singoos_idea_hi_m)/sum(tot_discwdis_singoos_idea_m)* 100,
           am_m = sum(sch_discwdis_singoos_idea_am_m)/sum(tot_discwdis_singoos_idea_m)* 100,
           as_m = sum(sch_discwdis_singoos_idea_as_m)/sum(tot_discwdis_singoos_idea_m)* 100,
           hp_m = sum(sch_discwdis_singoos_idea_hp_m)/sum(tot_discwdis_singoos_idea_m)* 100,
           wh_m = sum(sch_discwdis_singoos_idea_wh_m)/sum(tot_discwdis_singoos_idea_m)* 100,
           tr_m = sum(sch_discwdis_singoos_idea_tr_m)/sum(tot_discwdis_singoos_idea_m)* 100) %>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "one_out_susp_wdis_race_m")
one_out_susp_wdis_race_m 

one_out_susp_wdis_race_f <- one_out_susp %>% 
  summarize(bl_f = sum(sch_discwdis_singoos_idea_bl_f)/sum(tot_discwdis_singoos_idea_f) * 100, 
           hi_f = sum(sch_discwdis_singoos_idea_hi_f)/sum(tot_discwdis_singoos_idea_f)* 100,
           am_f = sum(sch_discwdis_singoos_idea_am_f)/sum(tot_discwdis_singoos_idea_f)* 100,
           as_f = sum(sch_discwdis_singoos_idea_as_f)/sum(tot_discwdis_singoos_idea_f)* 100,
           hp_f = sum(sch_discwdis_singoos_idea_hp_f)/sum(tot_discwdis_singoos_idea_f)* 100,
           wh_f = sum(sch_discwdis_singoos_idea_wh_f)/sum(tot_discwdis_singoos_idea_f)* 100,
           tr_f = sum(sch_discwdis_singoos_idea_tr_f)/sum(tot_discwdis_singoos_idea_f)* 100) %>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "one_out_susp_wdis_race_f")
one_out_susp_wdis_race_f
```

  * Student without disability with more than one out-of-school-suspensions by race and gender

```{r, eval = FALSE}
more_out_susp_wodis_race_m <- more_out_susp %>% 
  summarize(bl_m = sum(sch_discwodis_multoos_bl_m)/sum(tot_discwodis_multoos_m) * 100, 
           hi_m = sum(sch_discwodis_multoos_hi_m)/sum(tot_discwodis_multoos_m)* 100,
           am_m = sum(sch_discwodis_multoos_am_m)/sum(tot_discwodis_multoos_m)* 100,
           as_m = sum(sch_discwodis_multoos_as_m)/sum(tot_discwodis_multoos_m)* 100,
           hp_m = sum(sch_discwodis_multoos_hp_m)/sum(tot_discwodis_multoos_m)* 100,
           wh_m = sum(sch_discwodis_multoos_wh_m)/sum(tot_discwodis_multoos_m)* 100,
           tr_m = sum(sch_discwodis_multoos_tr_m)/sum(tot_discwodis_multoos_m)* 100) %>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "more_out_susp_wodis_race_m")
more_out_susp_wodis_race_m 

more_out_susp_wodis_race_f <- more_out_susp %>% 
  summarize(bl_f = sum(sch_discwodis_multoos_bl_f)/sum(tot_discwodis_multoos_f) * 100, 
           hi_f = sum(sch_discwodis_multoos_hi_f)/sum(tot_discwodis_multoos_f)* 100,
           am_f = sum(sch_discwodis_multoos_am_f)/sum(tot_discwodis_multoos_f)* 100,
           as_f = sum(sch_discwodis_multoos_as_f)/sum(tot_discwodis_multoos_f)* 100,
           hp_f = sum(sch_discwodis_multoos_hp_f)/sum(tot_discwodis_multoos_f)* 100,
           wh_f = sum(sch_discwodis_multoos_wh_f)/sum(tot_discwodis_multoos_f)* 100,
           tr_f = sum(sch_discwodis_multoos_tr_f)/sum(tot_discwodis_multoos_f)* 100)  %>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "more_out_susp_wodis_race_f")
more_out_susp_wodis_race_f

```

  * Student with disability with more than one out-of-school-suspensions by race and gender

```{r, eval = FALSE}
more_out_susp_wdis_race_m <- more_out_susp %>% 
  summarize(bl_m = sum(sch_discwdis_multoos_idea_bl_m)/sum(tot_discwdis_multoos_idea_m) * 100, 
           hi_m = sum(sch_discwdis_multoos_idea_hi_m)/sum(tot_discwdis_multoos_idea_m)* 100,
           am_m = sum(sch_discwdis_multoos_idea_am_m)/sum(tot_discwdis_multoos_idea_m)* 100,
           as_m = sum(sch_discwdis_multoos_idea_as_m)/sum(tot_discwdis_multoos_idea_m)* 100,
           hp_m = sum(sch_discwdis_multoos_idea_hp_m)/sum(tot_discwdis_multoos_idea_m)* 100,
           wh_m = sum(sch_discwdis_multoos_idea_wh_m)/sum(tot_discwdis_multoos_idea_m)* 100,
           tr_m = sum(sch_discwdis_multoos_idea_tr_m)/sum(tot_discwdis_multoos_idea_m)* 100)  %>% 
  pivot_longer(cols = 
                 c(bl_m, hi_m, am_m, as_m, hp_m, wh_m,tr_m),
               names_to = "race", 
               values_to = "more_out_susp_wdis_race_m")
more_out_susp_wdis_race_m 

more_out_susp_wdis_race_f <- more_out_susp %>% 
  summarize(bl_f = sum(sch_discwdis_multoos_idea_bl_f)/sum(tot_discwdis_multoos_idea_f) * 100, 
           hi_f = sum(sch_discwdis_multoos_idea_hi_f)/sum(tot_discwdis_multoos_idea_f)* 100,
           am_f = sum(sch_discwdis_multoos_idea_am_f)/sum(tot_discwdis_multoos_idea_f)* 100,
           as_f = sum(sch_discwdis_multoos_idea_as_f)/sum(tot_discwdis_multoos_idea_f)* 100,
           hp_f = sum(sch_discwdis_multoos_idea_hp_f)/sum(tot_discwdis_multoos_idea_f)* 100,
           wh_f = sum(sch_discwdis_multoos_idea_wh_f)/sum(tot_discwdis_multoos_idea_f)* 100,
           tr_f = sum(sch_discwdis_multoos_idea_tr_f)/sum(tot_discwdis_multoos_idea_f)* 100)%>% 
  pivot_longer(cols = c(bl_f, hi_f, am_f, as_f, hp_f, wh_f,tr_f),
               names_to = "race",
               values_to = "more_out_susp_wdis_race_f")
more_out_susp_wdis_race_f

```


*The next step is combining all suspensions categories based on gender*


```{r, eval = FALSE}
all_race_m <- left_join(pre_one_susp_race_m, pre_more_susp_race_m) %>% 
  left_join(in_susp_wdis_race_m) %>% 
  left_join(one_out_susp_wodis_race_m) %>% 
  left_join(one_out_susp_wdis_race_m) %>% 
  left_join(more_out_susp_wodis_race_m) %>% 
  left_join(more_out_susp_wdis_race_m)
  
all_race_f <- left_join(pre_one_susp_race_f,pre_more_susp_race_f) %>% 
  left_join(in_susp_wdis_race_f) %>% 
  left_join(one_out_susp_wodis_race_f) %>% 
  left_join(one_out_susp_wdis_race_f) %>% 
  left_join(more_out_susp_wodis_race_f) %>% 
  left_join(more_out_susp_wdis_race_f)
```


```{r, eval = FALSE}
all_race_male <- cbind(all_race_m[1], stack(all_race_m[2:8])) %>% 
  select(race, ind, values) %>% 
  mutate_at(vars(values), funs(round(., 1)))

all_race_female <- cbind(all_race_f[1], stack(all_race_f[2:8])) %>% 
  select(race, ind, values) %>% 
  mutate_at(vars(values), funs(round(., 1)))

```

*At the end, we would like to visualize our date to show the suspensions data based on race and gender proportion 

  * Suspensions for male students by race

```{r Plot-race-suspensions, echo=FALSE, fig.height=10, fig.width=10, eval = FALSE}
all_race_male %>% 
  ggplot(aes(fill= race, x=ind, y=values))+
  geom_bar(position = "stack", stat= "identity", color = "black", width = 0.9)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  geom_text(aes(label = paste0(values, "%")),
            position = position_stack(vjust = 0.5), size = 2) + 
  labs(x = "Suspensions", 
       y = "Percentage",
       title = "Male Students Receiving Suspension, by Race, Gender, and Disability")

```

  * Suspension for female students by race
```{r echo=FALSE, fig.height=10, fig.width=10, eval = FALSE}
all_race_female %>% 
  ggplot(aes(fill= race, x=ind, y=values))+
  geom_bar(position = "stack", stat= "identity", color = "black", width = 0.9)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  geom_text(aes(label = paste0(values, "%")),
            position = position_stack(vjust = 0.5), size = 2)+ 
    labs(x = "Suspensions", 
       y = "Percentage",
       title = "Female Students Receiving Suspension, by Race, Gender, and Disability",
       color = "Race")
```
  


### Arrest and Referrals

We'll add some figures here.

### Joined Data

We'll add some figures here.

# Methods

This analysis was conducted using publicly available data from the 2017-18 civil rights data collection. Each biennium, schools across the United States are required to respond and report key information about their school. This includes enrollment information, levels of school personnel, incidents of exclusionary discipline, harassment, and bullying.

## Sample and Exclusion Criteria

The sample in this study included K-12 schools across the United States. Overall, the 2017-18 civil rights data collection contains XXX schools who serve students in Grades K-12.  Schools categorized **{update when we figure out which schools are excluded** were excluded from the analysis.  The final sample included XX schools across the United States. Table 1 summarizes information on the study sample (see table x in the appendix). 

## Study Variables
The main predictor variable for research question one was the percent of teachers that are novice teachers at a school. This variable was calculated by dividing the number of novice teachers at a school by the total number of full time teachers. Across schools in our sample, the mean rate of novice teachers was X, and the numbers ranged from X to X. The main predictor of interest for research question two was the number of security personnel (sworn law enforcement officers and other security personnel) per 1000 students Across the school sample, the average rate of security personnel was X per 1000 students.

The analysis had three outcomes of interest that broadly examined school climate — one for research question one and two for RQ2. For research question 1, the main outcome of interest was the rate of students who received an exclusionary discipline (suspension and expulsion). More specifically, this variable was defined as the number of exclusionary cases per 1000 students at a school. For research question 2, the two variables of interest were rates of harassment/bullying and rates of referrals and arrests. Rate of harrassment and bulling was defined as the number of students per 1000 students who were disciplined for harassment/bullying. Rate of referral/arrests was defined as the number of students per 1000 students who received a referral or were arrested.

## Analytic Approach
Descriptive statistics and regression analysis were used to answer the two research questions. 

To answer the first research question, we used a 3-level hierarchical linear model with schools nested within districts and districts nested within states. The final model is represented by the following sets of equations. 
<!-- Would recommend separating these out from the paragraph of text so they each appear on their own line. Hard to read/follow when they just flow together on one line in the knitted document -->
Y_jks= π_0ks+X_j+ 〖γ1〗_j Noviceteachers+ ε_jks
π_ks=β_00s+ r_0jk 
β_00s= γ_000+ μ_00k
Where the outcome (Y) of school (j) in district (k) in state (s) is predicted by a set of school level enrollment covariates (X_j) and a school level measure of counselor caseload. The γ1 coefficient represents the relationship between counselor caseload and study outcomes and addresses the first research question.

To answer the second research question...

## Second Research Question
```{r}
#getwd()
```

```{r}
na_strings <- c(-3, -5, -6, -8, -9, -11)
```

```{r}
RA <- import(here("data", "Referrals and Arrests.csv")) %>%
as_tibble() %>%
 
set_na(na = c(-3, -5, -6, -8, -9, -11))
RA
```

```{r}
skim(RA)
```

<!-- Both the code chunk above and below create really long tables in the knitted document. Can you condense how much shows in the knitted document? Do you need all of those rows to show?  -->
Describe the RA data set
```{r}
RA %>%
  describeBy()
```

```{r}
enroll <- import(here("data", "enroll.csv")) %>%
as_tibble() %>%
 
set_na(na = c(-3, -5, -6, -8, -9, -11))
```

Describe the enroll data set
```{r}
enroll %>%
  describeBy()
```

```{r}
ra_full <- full_join(enroll, RA)

ra_full
```

```{r}
#export(ra_full, here("data", "ra_full.csv"))
```

```{r}
sch_su <- import(here("data", "sch_su.csv")) %>%
as_tibble() %>%
 
set_na(na = c(-3, -5, -6, -8, -9, -11))

sch_su
```

```{r}
ra_full_c <- ra_full %>%
  clean_names()
```

Complete data set
```{r}
ra_final <- full_join(ra_full_c, sch_su)

ra_final
```


```{r}
#export(ra_final, here("data", "ra_final.csv"))
```

Dropping variables to show just the state and totals
```{r}
ra_lawst <- ra_final %>%
select(lea_state_name, starts_with("tot")) %>%
  set_na(na = c(-3, -5, -6, -8, -9, -11))

ra_lawst
```

Sum by state
```{r}
ra_sum <- ra_lawst %>%
  group_by(lea_state_name) %>%
  summarise_all(sum, na.rm = TRUE) %>%
  filter(lea_state_name != "NA")

ra_sum
```

```{r}
# export(ra_lawst, here("data", "ra_lawst.xlsx"))
```

pivot_longer to rearrange the data with less columns & more rows
```{r}
ra_sum2 <- ra_sum %>%
  pivot_longer(cols = starts_with("tot_"),
    names_to = "student_type",
    names_prefix = "tot_disc",
    values_to = "tot_st",
    values_drop_na = TRUE)

ra_sum2
```

IDEA (Individuals with Disabilities Education Act)
LEP stands for limited English Proficient
arr = Arrests, ref = referrals, wdis = with disability, & wodis = with out disability
```{r}
ra_sum3 <- ra_sum2 %>%
  mutate_at("student_type", str_replace, "_idea", "") %>%
  separate(student_type, c("status", "dis_act", "gender"), "_")

ra_sum3
```

```{r}
new_labels <- c("ref" = "Referrals", "arr" = "Arrests")
```

How to get it to show a break in the gender indicating disability status or a percentage of each gender that is disabled?
fct_rev added to flip state names alphabetical
labeller used to spell out facet_wrap labels
<!-- These tables look amazing! Great job on them!  -->
```{r}
ra_sum3 %>%
  ggplot(aes(x = fct_rev(lea_state_name), y = tot_st)) +
  geom_col(aes(fill = gender)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip() +
  facet_wrap(~dis_act, labeller = labeller(dis_act = new_labels)) +
  theme(panel.grid.major.y = element_line(colour = "black"), panel.background = element_blank(), strip.background =element_rect(fill="gold1")) +
  labs(x = "State",
       y = "Total",
       title = "Number of Student Arrests and Referrals by State",
       subtitle = "Visulalized by Gender") +
  scale_fill_discrete (name = "Gender", labels = c("Female", "Male"))
```

```{r}
ra_sum3 %>%
  ggplot(aes(x = fct_rev(lea_state_name), y = tot_st)) +
  geom_col(aes(fill = status)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  coord_flip() +
  facet_wrap(~dis_act, labeller = labeller(dis_act = new_labels)) +
  theme(panel.grid.major.y = element_line(colour = "black"), panel.background = element_blank(), strip.background =element_rect(fill="darkolivegreen3")) +
  labs(x = "State",
       y = "Total",
       title = "Number of Student Arrests and Referrals by State",
       subtitle = "Visulalized by Disability Status") +
  scale_fill_manual (name = "Disability Status", values = c("darksalmon", "tomato4"), labels = c("Yes", "No"))
```

Multiple Regression
```{r}
ra_final %>%
  colnames ()
```

Changed "Not Reported" data to NA; checked that code worked by searching for the phrase in the view data pane
```{r}
ra_reg <- ra_final %>%
select(lea_state, lea_state_name, leaid, lea_name, schid, sch_name, combokey, jj, enroll_all, starts_with("tot"), sch_ftesecurity_leo, sch_ftesecurity_gua) %>%
  set_na(na = c("Not Reported"))

ra_reg
```

Still working on this code & will update soon...
```{r, eval= FALSE}
#Some error in this chunk 

ra_tidy <- ra_lawst %>%
  group_by(lea_state_name) %>%
  summarise_all(sum, na.rm = TRUE) %>%
  filter(lea_state_name != "NA")

pivot_longer(cols = starts_with("tot_"),
    names_to = "student_type",
    names_prefix = "tot_disc",
    values_to = "tot_st",
    values_drop_na = TRUE)

mutate_at("student_type", str_replace, "_idea", "") %>%
  separate(student_type, c("status", "dis_act", "gender"), "_")

ra_sum2
```


```{r, eval = FALSE}
ra_tidy %>%
  describeBy()
```



# Results

## Research Quesiton 1

```{r}

#This throws error for me because of space. Guess we have a lot of data loaded in the prev. chunks

rq1 <- import(here("data","data_join.csv")) %>%
  as_tibble() %>%
  mutate(leaid = as.numeric(leaid),
         lea_state = as.factor(lea_state)) %>%
  filter(!is.na(susp_std)) %>%
  filter(!is.na(pct_new_teachers)) %>%
  filter(pct_new_teachers != Inf)

control <- c("tot_enr","sch_enr_am", "sch_enr_as", "sch_enr_bl", "sch_enr_hi",
             "sch_enr_hp", "sch_enr_tr","sch_enr_wh","sch_enr_lep","sch_enr_idea",
             "sch_status_sped","sch_status_magnet", "sch_status_charter","sch_status_alt")
rq1_m0 <- lmer(susp_std ~ pct_new_teachers + (1 | leaid) + (1 | lea_state), 
               data = rq1, na.action = na.pass)

lm(susp_std ~ pct_new_teachers, data = rq1 )

rq1_m1 <- lmer(susp_std ~ pct_new_teachers + tot_enr + sch_enr_am + sch_enr_as + 
                 sch_enr_bl + sch_enr_hi + sch_enr_hp + sch_enr_tr + sch_enr_wh + 
                 sch_enr_wh + sch_enr_lep + sch_enr_idea + sch_status_sped + 
                 sch_status_magnet + sch_status_charter + sch_status_alt + 
                 (1 | leaid) + (1 | lea_state), 
               data = rq1)

tab_model(rq1_m0, rq1_m1, collapse.ci = TRUE, p.style = "stars",
          pred.labels = c("Intercept", "Percent New Teachers", "Total Enrollment",
                        "Percent American Indian", "Percent Asian",
                        "Percent Black", "Percent Latinx", "Percent Hawaiian/Pacific Islander",
                        "Percent Multiracial", "Percent EL Classified", "Percent Special Ed.",
                        "Special Ed School (Y/N)", "Magnet school ((Y/N)", 
                        "Charter School (Y/N)", "Alternative School (Y/N)"))
```

# Discussion

# References

# Appendix


**Note: This section was written early in the term. We'll most probably remove it for the final submission.**


In this section, I will import the enrollment file and subset it to keep relevant variables. This file will be the base file. 

```{r, eval = FALSE}
#Importing the Enrollment file
enroll<- read_csv(here("data", "Enrollment.csv")) %>%
  as_tibble() %>%
  subset(select = -c(9:31))
```

Exploring the file - I notice that there are some minimum values that are less than
zero, negative values don't make sense for enrollment. Need to replace those to 
missing.

```{r, eval = FALSE }
skim(enroll)
``` 


First, need to replace values that have negative values with a missing value, then
creating enrollment counts for race/ethnicity groups as well as EL and SPED.

```{r, eval = FALSE }
enroll <- enroll %>%
  mutate_all(~replace(., . < 0, NA)) %>%
  mutate(enroll_all = TOT_ENR_M + TOT_ENR_F,
         enroll_latinx = SCH_ENR_HI_M + SCH_ENR_HI_F,
         enroll_aian = SCH_ENR_AM_M + SCH_ENR_AM_F,
         enroll_asianam = SCH_ENR_AS_M + SCH_ENR_AS_F,
         enroll_nhpi = SCH_ENR_HP_M + SCH_ENR_HP_F,
         enroll_black = SCH_ENR_BL_M + SCH_ENR_BL_F,
         enroll_white = SCH_ENR_WH_M + SCH_ENR_WH_F,
         enroll_twomore = SCH_ENR_TR_M + SCH_ENR_TR_F,
         enroll_el = SCH_ENR_LEP_M + SCH_ENR_LEP_F,
         enroll_elserv = TOT_LEPPROGENR_M + TOT_LEPPROGENR_F,
         enroll_sped = SCH_ENR_IDEA_M + SCH_ENR_IDEA_F)
```

Checking to see if the code worked by checking the distribution of all the variables. 
In theory, none should go below zero in these box graphs. Based on the results, it appears
as if this worked out well 

```{r, eval = FALSE }
enroll %>% 
  melt(id.vars = "SCH_NAME", 
       measure.vars = c("enroll_all", "enroll_latinx", "enroll_aian", "enroll_asianam",
                        "enroll_nhpi", "enroll_black", "enroll_white", "enroll_twomore",
                        "enroll_el", "enroll_elserv", "enroll_sped"),
       variable.name = "Group",
       value.name = "Count") %>%
  ggplot(aes(x = Count, y = Group)) +
  geom_boxplot() + 
  theme_minimal()
```

Now creating a set of new variables. I am creating enrollment percents for each
race/ethnicity group as well as EL and SPED.

```{r, eval = FALSE }
enroll <- enroll %>%
  mutate(enroll_latinx_pct = (enroll_latinx/enroll_all)*100,
         enroll_aian_pct = (enroll_aian/enroll_all)*100,
         enroll_asianam_pct = (enroll_asianam/enroll_all)*100,
         enroll_nhpi_pct = (enroll_nhpi/enroll_all)*100,
         enroll_black_pct = (enroll_black/enroll_all)*100,
         enroll_white_pct = (enroll_white/enroll_all)*100,
         enroll_twomore_pct = (enroll_twomore/enroll_all)*100,
         enroll_el_pct = (enroll_el/enroll_all)*100,
         enroll_elserv_pct = (enroll_elserv/enroll_all)*100,
         enroll_sped_pct = (enroll_sped/enroll_all)*100)
```

Also checking to see distribution of all the variables by ploting them. I notice some 
are reporting percents higher than 100. For example, some schools, the percent of students
who are EL enrolled is greater than 100. This shouldn't be the case.

```{r, eval = FALSE }
enroll %>% 
  melt(id.vars = "SCH_NAME", 
       measure.vars = c( "enroll_latinx_pct", "enroll_aian_pct", "enroll_asianam_pct",
                        "enroll_nhpi_pct", "enroll_black_pct", "enroll_white_pct", "enroll_twomore_pct",
                        "enroll_el_pct", "enroll_elserv_pct", "enroll_sped_pct"),
       variable.name = "Group",
       value.name = "Count") %>%
  ggplot(aes(x = Count, y = Group)) +
  geom_boxplot() + 
  theme_minimal()

enroll %>%
    filter(enroll_el_pct > 100) %>%
    select(SCH_NAME,SCH_ENR_LEP_F,SCH_ENR_LEP_M, enroll_el, enroll_all, enroll_el_pct)
```

Recoding those schools that report percentages higher than 100. Doing this for EL% and SPED%.
For those cases, I just recoded back to 100 percent. It appears like it worked based on the visual.
Afterwards, I subset the file to only keep the school information, enrollment totals, and percent enrollment.

```{r, eval = FALSE }
enroll <- enroll %>%
  mutate(enroll_el_pct = ifelse(enroll_el_pct > 100,100,enroll_el_pct),
         enroll_elserv_pct = ifelse(enroll_elserv_pct > 100,100,enroll_elserv_pct),
         enroll_sped_pct = ifelse(enroll_sped_pct > 100,100,enroll_sped_pct)) 
```
  
Creating  District Level Independent variables (% EL, % SPED, % students of color)

```{r, eval = FALSE }
enroll <- enroll %>%
  group_by(LEAID) %>%
  mutate(dist_enrollment = sum(enroll_all),
         dist_percent_white = (sum(enroll_white)/dist_enrollment)*100,
         dist_percent_latinx = (sum(enroll_latinx)/dist_enrollment)*100,
         dist_percent_black = (sum(enroll_black)/dist_enrollment)*100,
         dist_percent_twomore = (sum(enroll_twomore)/dist_enrollment)*100,
         dist_percent_asianam= (sum(enroll_asianam)/dist_enrollment)*100,
         dist_percent_nhpi = (sum(enroll_nhpi)/dist_enrollment)*100,
         dist_percent_aian = (sum(enroll_aian)/dist_enrollment)*100,
         dist_percent_el = (sum(enroll_el)/dist_enrollment)*100,
         dist_percent_sped = (sum(enroll_sped)/dist_enrollment)*100
         )

enroll %>%
  melt(id.vars = "SCH_NAME", 
       measure.vars = c( "dist_percent_white", "dist_percent_latinx", "dist_percent_black",
                        "dist_percent_twomore", "dist_percent_asianam", "dist_percent_nhpi",
                        "dist_percent_aian", "dist_percent_el", "dist_percent_sped"),
       variable.name = "Group",
       value.name = "Percent") %>%
  ggplot(aes(x = Percent, y = Group)) +
  geom_boxplot() + 
  theme_minimal()
  


enroll %>%
  ggplot(aes(x = dist_enrollment, y = LEA_STATE_NAME)) +
  geom_density_ridges() + theme_minimal()
```

Replacing district rates with values greater than 100 to just 100

```{r, eval = FALSE }

enroll <- enroll %>%
  mutate(dist_percent_el = ifelse(dist_percent_el > 100,100,dist_percent_el),
         dist_percent_sped = ifelse(dist_percent_sped > 100,100,dist_percent_sped))

enroll %>%
  melt(id.vars = "SCH_NAME", 
       measure.vars = c( "dist_percent_white", "dist_percent_latinx", "dist_percent_black",
                        "dist_percent_twomore", "dist_percent_asianam", "dist_percent_nhpi",
                        "dist_percent_aian", "dist_percent_el", "dist_percent_sped"),
       variable.name = "Group",
       value.name = "Percent") %>%
  ggplot(aes(x = Percent, y = Group)) +
  geom_boxplot() + 
  theme_minimal()
``` 
  
Making the dataset smaller and just keeping variables that we need  
  
```{r, eval = FALSE }  
enroll <- enroll %>%  
select(c("LEA_STATE", "LEA_STATE_NAME", "LEAID", "LEA_NAME", "SCHID", "SCH_NAME", 
          "COMBOKEY", "JJ",  "enroll_all", "enroll_latinx", "enroll_aian", "enroll_asianam",
           "enroll_nhpi", "enroll_black", "enroll_white", "enroll_twomore",
           "enroll_el", "enroll_elserv", "enroll_sped","enroll_latinx_pct", 
          "enroll_aian_pct", "enroll_asianam_pct", "enroll_nhpi_pct", "enroll_black_pct", 
          "enroll_white_pct", "enroll_twomore_pct","enroll_el_pct", "enroll_elserv_pct", "enroll_sped_pct",
          "dist_percent_white", "dist_percent_latinx", "dist_percent_black",
          "dist_percent_twomore", "dist_percent_asianam", "dist_percent_nhpi",
          "dist_percent_aian", "dist_percent_el", "dist_percent_sped"))
```

*END OF ENROLLMENT DATA CLEANING*
